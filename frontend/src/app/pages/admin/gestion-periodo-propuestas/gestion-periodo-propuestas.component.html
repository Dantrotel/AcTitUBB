<div class="page-container">
  <nav class="navbar">
    <button class="btn-back" (click)="volver()">
      <i class="fas fa-arrow-left"></i>
      Volver
    </button>
    <h1>
      <i class="fas fa-calendar-check"></i>
      Gesti√≥n del Per√≠odo de Propuestas
    </h1>
  </nav>

  <div class="page-content">
    <!-- Alerts -->
    <div class="alert alert-error" *ngIf="error">
      <i class="fas fa-exclamation-circle"></i>
      <span>{{ error }}</span>
    </div>

    <div class="alert alert-success" *ngIf="mensaje">
      <i class="fas fa-check-circle"></i>
      <span>{{ mensaje }}</span>
    </div>

    <!-- Loading -->
    <div class="loading-state" *ngIf="loading && !estadoPeriodo">
      <div class="spinner"></div>
      <p>Cargando informaci√≥n del per√≠odo...</p>
    </div>

    <!-- Sin Per√≠odo Configurado -->
    <div class="empty-state" *ngIf="!loading && estadoPeriodo && !estadoPeriodo.existe">
      <i class="fas fa-calendar-times"></i>
      <h2>No hay per√≠odo de propuestas configurado</h2>
      <p>Debes crear una fecha l√≠mite para entrega de propuestas desde el calendario.</p>
      <button class="btn btn-primary" (click)="irACalendario()">
        <i class="fas fa-calendar-plus"></i>
        Ir al Calendario
      </button>
    </div>

    <!-- Estado del Per√≠odo -->
    <div class="content-grid" *ngIf="!loading && estadoPeriodo && estadoPeriodo.existe">
      
      <!-- Tarjeta de Estado -->
      <div class="estado-card" [ngClass]="getEstadoClass()">
        <div class="estado-header">
          <div class="estado-icon">
            <i [class]="estadoPeriodo.habilitada ? 'fas fa-lock-open' : 'fas fa-lock'"></i>
          </div>
          <div class="estado-info">
            <h2>{{ estadoPeriodo.titulo }}</h2>
            <p class="descripcion" *ngIf="estadoPeriodo.descripcion">
              {{ estadoPeriodo.descripcion }}
            </p>
          </div>
          <div class="estado-badge">
            <span [ngClass]="getEstadoClass()">
              {{ getEstadoLabel() }}
            </span>
          </div>
        </div>

        <div class="estado-body">
          <div class="info-grid">
            <div class="info-item">
              <i class="fas fa-calendar-day"></i>
              <div>
                <label>Fecha L√≠mite:</label>
                <span class="valor">{{ formatearFecha(estadoPeriodo.fecha_limite) }}</span>
              </div>
            </div>

            <div class="info-item">
              <i class="fas fa-hourglass-half"></i>
              <div>
                <label>Tiempo Restante:</label>
                <span class="valor" [ngClass]="{
                  'urgente': estadoPeriodo.dias_restantes !== undefined && estadoPeriodo.dias_restantes <= 3,
                  'vencido': estadoPeriodo.dias_restantes !== undefined && estadoPeriodo.dias_restantes < 0
                }">
                  {{ getDiasRestantesTexto() }}
                </span>
              </div>
            </div>

            <div class="info-item">
              <i [class]="estadoPeriodo.habilitada ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
              <div>
                <label>Estado del Per√≠odo:</label>
                <span class="valor" [class.activo]="estadoPeriodo.habilitada" [class.inactivo]="!estadoPeriodo.habilitada">
                  {{ estadoPeriodo.habilitada ? 'HABILITADO' : 'DESHABILITADO' }}
                </span>
              </div>
            </div>

            <div class="info-item">
              <i [class]="estadoPeriodo.puede_recibir_propuestas ? 'fas fa-upload' : 'fas fa-ban'"></i>
              <div>
                <label>Acepta Propuestas:</label>
                <span class="valor" [class.activo]="estadoPeriodo.puede_recibir_propuestas" [class.inactivo]="!estadoPeriodo.puede_recibir_propuestas">
                  {{ estadoPeriodo.puede_recibir_propuestas ? 'S√ç' : 'NO' }}
                </span>
              </div>
            </div>

            <div class="info-item">
              <i [class]="estadoPeriodo.permite_extension ? 'fas fa-clock' : 'fas fa-hourglass-end'"></i>
              <div>
                <label>Permite Extensiones:</label>
                <span class="valor">
                  {{ estadoPeriodo.permite_extension ? 'S√≠' : 'No' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Mensaje Informativo -->
          <div class="info-box" [ngClass]="{
            'info-success': estadoPeriodo.habilitada && estadoPeriodo.puede_recibir_propuestas,
            'info-warning': estadoPeriodo.habilitada && estadoPeriodo.dias_restantes !== undefined && estadoPeriodo.dias_restantes <= 3,
            'info-danger': !estadoPeriodo.habilitada || (estadoPeriodo.dias_restantes !== undefined && estadoPeriodo.dias_restantes < 0)
          }">
            <i [class]="estadoPeriodo.puede_recibir_propuestas ? 'fas fa-info-circle' : 'fas fa-exclamation-triangle'"></i>
            <div>
              <strong>{{ estadoPeriodo.puede_recibir_propuestas ? 'Sistema Activo' : 'Sistema Inactivo' }}</strong>
              <p *ngIf="estadoPeriodo.puede_recibir_propuestas">
                Los estudiantes pueden crear y enviar propuestas hasta el {{ formatearFecha(estadoPeriodo.fecha_limite) }}.
              </p>
              <p *ngIf="!estadoPeriodo.habilitada">
                El per√≠odo est√° cerrado manualmente. Los estudiantes NO pueden crear propuestas.
              </p>
              <p *ngIf="estadoPeriodo.habilitada && estadoPeriodo.dias_restantes !== undefined && estadoPeriodo.dias_restantes < 0">
                El per√≠odo ha vencido. Los estudiantes NO pueden crear propuestas. Puedes deshabilitarlo autom√°ticamente.
              </p>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div class="estado-actions">
          <button 
            class="btn btn-success"
            *ngIf="!estadoPeriodo.habilitada"
            (click)="habilitarPeriodo()"
            [disabled]="loading">
            <i [class]="loading ? 'fas fa-spinner fa-spin' : 'fas fa-lock-open'"></i>
            {{ loading ? 'Habilitando...' : 'Habilitar Per√≠odo' }}
          </button>

          <button 
            class="btn btn-danger"
            *ngIf="estadoPeriodo.habilitada"
            (click)="deshabilitarPeriodo()"
            [disabled]="loading">
            <i [class]="loading ? 'fas fa-spinner fa-spin' : 'fas fa-lock'"></i>
            {{ loading ? 'Deshabilitando...' : 'Deshabilitar Per√≠odo' }}
          </button>

          <button 
            class="btn btn-warning"
            (click)="deshabilitarVencidos()"
            [disabled]="loading">
            <i class="fas fa-broom"></i>
            Deshabilitar Per√≠odos Vencidos
          </button>

          <button 
            class="btn btn-secondary"
            (click)="irACalendario()">
            <i class="fas fa-calendar-alt"></i>
            Ver Calendario Completo
          </button>
        </div>
      </div>

      <!-- Todas las Fechas Importantes -->
      <div class="fechas-importantes-section">
        <h3 class="section-title">
          <i class="fas fa-calendar-alt"></i>
          Todos los Per√≠odos Publicados
        </h3>
        
        <!-- Mensaje si no hay fechas -->
        <div class="empty-state" *ngIf="todasLasFechas.length === 0">
          <i class="fas fa-calendar-times"></i>
          <p>No hay per√≠odos publicados actualmente.</p>
          <p class="text-muted">Crea fechas globales desde el Calendario Global para que aparezcan aqu√≠.</p>
          <button class="btn btn-primary" (click)="irACalendario()">
            <i class="fas fa-calendar-plus"></i>
            Ir al Calendario Global
          </button>
        </div>
        
        <div class="fechas-grid" *ngIf="todasLasFechas.length > 0">
          <div *ngFor="let fecha of todasLasFechas" 
               class="fecha-card"
               [ngClass]="'estado-' + getEstadoFecha(fecha.fecha_limite, fecha.habilitada)">
            <div class="fecha-header">
              <div class="fecha-icon">
                <i [class]="getTipoFechaIcon(fecha.tipo_fecha)"></i>
              </div>
              <div class="fecha-info">
                <h4>{{ fecha.titulo }}</h4>
                <span class="fecha-tipo">{{ getTipoFechaLabel(fecha.tipo_fecha) }}</span>
              </div>
              <div class="fecha-estado-badge" [ngClass]="'badge-' + getEstadoFecha(fecha.fecha_limite, fecha.habilitada)">
                <span *ngIf="getEstadoFecha(fecha.fecha_limite, fecha.habilitada) === 'activo'">Activo</span>
                <span *ngIf="getEstadoFecha(fecha.fecha_limite, fecha.habilitada) === 'proximo'">Pr√≥ximo</span>
                <span *ngIf="getEstadoFecha(fecha.fecha_limite, fecha.habilitada) === 'urgente'">¬°Urgente!</span>
                <span *ngIf="getEstadoFecha(fecha.fecha_limite, fecha.habilitada) === 'hoy'">¬°HOY!</span>
                <span *ngIf="getEstadoFecha(fecha.fecha_limite, fecha.habilitada) === 'vencido'">Vencido</span>
                <span *ngIf="getEstadoFecha(fecha.fecha_limite, fecha.habilitada) === 'cerrado'">Cerrado</span>
              </div>
            </div>
            
            <div class="fecha-body">
              <p class="fecha-descripcion" *ngIf="fecha.descripcion">{{ fecha.descripcion }}</p>
              
              <div class="fecha-detalles">
                <div class="detalle-item">
                  <i class="fas fa-calendar-day"></i>
                  <span><strong>Fecha l√≠mite:</strong> {{ formatearFecha(fecha.fecha_limite) }}</span>
                </div>
                
                <div class="detalle-item">
                  <i class="fas fa-hourglass-half"></i>
                  <span><strong>D√≠as restantes:</strong> 
                    <span [ngClass]="{
                      'text-success': calcularDiasRestantes(fecha.fecha_limite) > 7,
                      'text-warning': calcularDiasRestantes(fecha.fecha_limite) > 0 && calcularDiasRestantes(fecha.fecha_limite) <= 7,
                      'text-danger': calcularDiasRestantes(fecha.fecha_limite) <= 0
                    }">
                      {{ calcularDiasRestantes(fecha.fecha_limite) > 0 ? calcularDiasRestantes(fecha.fecha_limite) + ' d√≠as' : 
                         calcularDiasRestantes(fecha.fecha_limite) === 0 ? 'Vence HOY' : 
                         'Vencido hace ' + Math.abs(calcularDiasRestantes(fecha.fecha_limite)) + ' d√≠as' }}
                    </span>
                  </span>
                </div>
                
                <div class="detalle-item">
                  <i [class]="fecha.habilitada ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger'"></i>
                  <span><strong>Estado:</strong> {{ fecha.habilitada ? 'Habilitado' : 'Deshabilitado' }}</span>
                </div>
              </div>
              
              <!-- Botones de Acci√≥n -->
              <div class="fecha-acciones">
                <button class="btn btn-secondary btn-sm" (click)="abrirModalEditar(fecha)" title="Editar fecha">
                  <i class="fas fa-edit"></i>
                  Editar
                </button>
                <button class="btn btn-danger btn-sm" (click)="confirmarEliminar(fecha)" title="Eliminar fecha">
                  <i class="fas fa-trash-alt"></i>
                  Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Instrucciones -->
      <div class="instrucciones-card">
        <h3>
          <i class="fas fa-question-circle"></i>
          ¬øC√≥mo funciona?
        </h3>
        <ul>
          <li>
            <strong>Habilitar Per√≠odo:</strong> Permite que los estudiantes creen y env√≠en propuestas.
          </li>
          <li>
            <strong>Deshabilitar Per√≠odo:</strong> Bloquea la creaci√≥n de nuevas propuestas inmediatamente.
          </li>
          <li>
            <strong>Deshabilitaci√≥n Autom√°tica:</strong> El sistema deshabilita autom√°ticamente los per√≠odos al alcanzar la fecha l√≠mite.
          </li>
          <li>
            <strong>Gesti√≥n Manual:</strong> Puedes habilitar/deshabilitar el per√≠odo en cualquier momento, independientemente de la fecha.
          </li>
          <li>
            <strong>Crear Nuevo Per√≠odo:</strong> Debes crear una nueva fecha en el calendario con tipo "Entrega de Propuesta" y marcarla como global.
          </li>
        </ul>

        <div class="tips-box">
          <h4>
            <i class="fas fa-lightbulb"></i>
            Recomendaciones
          </h4>
          <p>‚úÖ Habilita el per√≠odo con anticipaci√≥n para que los estudiantes tengan tiempo suficiente.</p>
          <p>‚ö†Ô∏è Avisa a los estudiantes antes de deshabilitar el per√≠odo manualmente.</p>
          <p>üîí Una vez vencida la fecha, el sistema bloquear√° autom√°ticamente las propuestas.</p>
          <p>üìÖ Mant√©n fechas claras y comun√≠calas en el calendario institucional.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Edici√≥n -->
<div class="modal-overlay" *ngIf="mostrarModalEditar" (click)="cerrarModalEditar()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-edit"></i>
        Editar Fecha de Entrega
      </h3>
      <button class="btn-close" (click)="cerrarModalEditar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="edit-titulo">
          <i class="fas fa-heading"></i>
          T√≠tulo *
        </label>
        <input 
          type="text" 
          id="edit-titulo"
          class="form-control"
          [(ngModel)]="fechaEditar.titulo"
          placeholder="Ej: Entrega de Propuestas Semestre 1"
          required>
      </div>
      
      <div class="form-group">
        <label for="edit-descripcion">
          <i class="fas fa-align-left"></i>
          Descripci√≥n
        </label>
        <textarea 
          id="edit-descripcion"
          class="form-control"
          [(ngModel)]="fechaEditar.descripcion"
          rows="3"
          placeholder="Descripci√≥n opcional de la fecha"></textarea>
      </div>
      
      <div class="form-group">
        <label for="edit-fecha">
          <i class="fas fa-calendar-day"></i>
          Fecha L√≠mite *
        </label>
        <input 
          type="date" 
          id="edit-fecha"
          class="form-control"
          [(ngModel)]="fechaEditar.fecha_limite"
          required>
      </div>
      
      <div class="form-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            [(ngModel)]="fechaEditar.habilitada">
          <span>Fecha habilitada (los estudiantes pueden crear propuestas)</span>
        </label>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalEditar()" [disabled]="guardando">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="guardarEdicion()" [disabled]="guardando || !fechaEditar.titulo || !fechaEditar.fecha_limite">
        <i [class]="guardando ? 'fas fa-spinner fa-spin' : 'fas fa-save'"></i>
        {{ guardando ? 'Guardando...' : 'Guardar Cambios' }}
      </button>
    </div>
  </div>
</div>

<!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
<div class="modal-overlay" *ngIf="mostrarModalEliminar" (click)="cancelarEliminar()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header modal-header-danger">
      <h3>
        <i class="fas fa-exclamation-triangle"></i>
        Confirmar Eliminaci√≥n
      </h3>
      <button class="btn-close" (click)="cancelarEliminar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <p class="text-center">
        ¬øEst√°s seguro de que deseas eliminar esta fecha?
      </p>
      <div class="fecha-eliminar-info">
        <strong>{{ fechaEliminar?.titulo }}</strong>
        <p>Fecha: {{ formatearFecha(fechaEliminar?.fecha_limite) }}</p>
      </div>
      <p class="text-danger text-center">
        <i class="fas fa-exclamation-circle"></i>
        Esta acci√≥n no se puede deshacer.
      </p>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelarEliminar()" [disabled]="eliminando">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button class="btn btn-danger" (click)="eliminarFecha()" [disabled]="eliminando">
        <i [class]="eliminando ? 'fas fa-spinner fa-spin' : 'fas fa-trash-alt'"></i>
        {{ eliminando ? 'Eliminando...' : 'Eliminar' }}
      </button>
    </div>
  </div>
</div>
