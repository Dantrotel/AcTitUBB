<div class="gestion-calendario-container">
  <div class="header">
    <div class="header-content">
      <h1><i class="fas fa-calendar-alt"></i> Gesti√≥n de Calendario</h1>
      <p>Administra las fechas globales del sistema acad√©mico</p>
    </div>
    <div class="header-actions">
      <button class="btn-volver-header" (click)="volver()">
        <i class="fas fa-arrow-left"></i>
        Volver
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner"></i>
    </div>
    <h3>Cargando fechas...</h3>
    <p>Obteniendo informaci√≥n del calendario</p>
  </div>

  <div *ngIf="error" class="error-container">
    <div class="error-icon">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h3>Error al cargar fechas</h3>
    <p>{{error}}</p>
    <button class="btn-primary" (click)="cargarFechas()">
      <i class="fas fa-sync-alt"></i>
      Reintentar
    </button>
  </div>

  <div *ngIf="!loading && !error">
    <!-- Secci√≥n de nueva fecha -->
    <div class="nueva-fecha-section">
      <div class="section-header">
        <h2><i class="fas fa-plus"></i> Crear Nueva Fecha Global</h2>
        <button class="btn-toggle" (click)="mostrarFormulario = !mostrarFormulario">
          <i [class]="mostrarFormulario ? 'fas fa-minus' : 'fas fa-plus'"></i>
          {{mostrarFormulario ? 'Ocultar' : 'Mostrar'}} Formulario
        </button>
      </div>

      <div class="formulario-container" [class.visible]="mostrarFormulario">
        <form (ngSubmit)="crearFecha()" #fechaForm="ngForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="titulo">T√≠tulo *</label>
              <input 
                type="text" 
                id="titulo" 
                name="titulo"
                [(ngModel)]="nuevaFecha.titulo" 
                required
                placeholder="Ej: Inicio de Semestre">
            </div>

            <div class="form-group">
              <label for="fecha">Fecha *</label>
              <input 
                type="date" 
                id="fecha" 
                name="fecha"
                [(ngModel)]="nuevaFecha.fecha" 
                required>
            </div>

            <div class="form-group">
              <label for="hora_limite">Hora L√≠mite *</label>
              <input 
                type="time" 
                id="hora_limite" 
                name="hora_limite"
                [(ngModel)]="nuevaFecha.hora_limite" 
                required>
              <small>Hora en que se deshabilitar√° la entrega autom√°ticamente</small>
            </div>

            <div class="form-group">
              <label for="tipo_fecha">Tipo de Fecha *</label>
              <select 
                id="tipo_fecha" 
                name="tipo_fecha"
                [(ngModel)]="nuevaFecha.tipo_fecha" 
                required>
                <option value="">Seleccionar tipo...</option>
                <optgroup label="üìö Fechas Acad√©micas">
                  <option value="academica">Evento Acad√©mico General</option>
                  <option value="inicio_semestre">Inicio de Semestre</option>
                  <option value="fin_semestre">Fin de Semestre</option>
                  <option value="feriado">Feriado / No Laborable</option>
                  <option value="receso">Receso Acad√©mico</option>
                </optgroup>
                <optgroup label="üìã Propuestas">
                  <option value="entrega_propuesta">‚≠ê Entrega de Propuestas (Control de Per√≠odo)</option>
                  <option value="revision_propuesta">Revisi√≥n de Propuestas</option>
                </optgroup>
                <optgroup label="üìÑ Entregas y Avances">
                  <option value="entrega">Entrega General</option>
                  <option value="entrega_avance">Entrega de Avance</option>
                  <option value="entrega_parcial">Entrega Parcial</option>
                  <option value="entrega_final">Entrega Final/Memoria</option>
                </optgroup>
                <optgroup label="üìä Evaluaciones">
                  <option value="evaluacion">Evaluaci√≥n</option>
                  <option value="revision">Revisi√≥n</option>
                  <option value="presentacion">Presentaci√≥n</option>
                  <option value="defensa">Defensa Final</option>
                  <option value="defensa_parcial">Defensa Parcial</option>
                </optgroup>
                <optgroup label="ü§ù Reuniones y Seguimiento">
                  <option value="reunion">Reuni√≥n</option>
                  <option value="seguimiento">Reuni√≥n de Seguimiento</option>
                  <option value="orientacion">Sesi√≥n de Orientaci√≥n</option>
                </optgroup>
                <optgroup label="üìÖ Hitos y Plazos">
                  <option value="hito">Hito del Proyecto</option>
                  <option value="deadline">Fecha L√≠mite</option>
                  <option value="plazo_extension">Plazo de Extensi√≥n</option>
                </optgroup>
                <optgroup label="üéØ Otros">
                  <option value="otro">Otro</option>
                </optgroup>
              </select>
            </div>

            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  id="es_global" 
                  name="es_global"
                  [(ngModel)]="nuevaFecha.es_global">
                <span class="checkbox-text">
                  <i class="fas fa-globe"></i>
                  <strong>Fecha Global</strong>
                  <span class="help-text">
                    (Requerido para "Entrega de Propuestas" - Controla el per√≠odo de env√≠o)
                  </span>
                </span>
              </label>
            </div>

            <div class="form-group full-width">
              <label for="descripcion">Descripci√≥n</label>
              <textarea 
                id="descripcion" 
                name="descripcion"
                [(ngModel)]="nuevaFecha.descripcion" 
                rows="3"
                placeholder="Descripci√≥n opcional de la fecha..."></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="!fechaForm.form.valid || guardando">
              <i class="fas fa-save"></i>
              {{guardando ? 'Guardando...' : 'Crear Fecha'}}
            </button>
            <button type="button" class="btn-secondary" (click)="limpiarFormulario()">
              <i class="fas fa-eraser"></i>
              Limpiar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="estadisticas-section" *ngIf="estadisticas">
      <h2><i class="fas fa-chart-bar"></i> Estad√≠sticas</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{estadisticas.total_fechas}}</div>
            <div class="stat-label">Total de Fechas</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-globe"></i>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{estadisticas.fechas_globales}}</div>
            <div class="stat-label">Fechas Globales</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{estadisticas.fechas_especificas}}</div>
            <div class="stat-label">Fechas Espec√≠ficas</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{estadisticas.fechas_futuras}}</div>
            <div class="stat-label">Fechas Futuras</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Fechas Importantes de Proyectos -->
    <div class="fechas-importantes-section">
      <div class="section-header">
        <h2><i class="fas fa-calendar-exclamation"></i> Fechas Importantes de Proyectos</h2>
        <button class="btn-toggle" (click)="toggleFechasImportantes()">
          <i [class]="mostrarFechasImportantes ? 'fas fa-minus' : 'fas fa-plus'"></i>
          {{mostrarFechasImportantes ? 'Ocultar' : 'Mostrar'}} Fechas
        </button>
      </div>

      <div class="fechas-importantes-container" [class.visible]="mostrarFechasImportantes">
        <div *ngIf="loadingFechasImportantes" class="loading-fechas">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Cargando fechas importantes...</span>
        </div>

        <div *ngIf="!loadingFechasImportantes && fechasImportantes.length === 0" class="empty-fechas">
          <i class="fas fa-calendar-plus"></i>
          <p>No hay fechas importantes definidas en los proyectos</p>
        </div>

        <div class="fechas-grid" *ngIf="!loadingFechasImportantes && fechasImportantes.length > 0">
          <div 
            *ngFor="let fecha of fechasImportantes" 
            class="fecha-importante-card"
            [class]="'fecha-' + fecha.estado"
          >
            <div class="fecha-header">
              <div class="fecha-tipo">
                <span class="tipo-badge">{{ formatearTipoFecha(fecha.tipo_fecha) }}</span>
              </div>
              <div class="fecha-estado">
                <span class="estado-badge" [class]="'estado-' + fecha.estado">
                  {{ formatearEstado(fecha.estado) }}
                </span>
              </div>
            </div>

            <div class="fecha-body">
              <h4>{{ fecha.titulo }}</h4>
              <p class="proyecto-info">
                <i class="fas fa-project-diagram"></i>
                <strong>{{ fecha.titulo_proyecto }}</strong>
              </p>
              <p class="estudiante-info">
                <i class="fas fa-user-graduate"></i>
                {{ fecha.nombre_estudiante }}
              </p>
              
              <div class="fecha-meta">
                <div class="fecha-limite">
                  <i class="fas fa-calendar"></i>
                  <span>{{ formatearFecha(fecha.fecha_limite) }}</span>
                </div>
                <div class="dias-restantes" *ngIf="fecha.dias_restantes !== null">
                  <i class="fas fa-clock"></i>
                  <span>{{ obtenerTextoTiempo(fecha.dias_restantes) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista de fechas globales -->
    <div class="fechas-section">
      <div class="section-header">
        <h2><i class="fas fa-list"></i> Fechas Globales ({{fechasGlobales.length}})</h2>
        <div class="section-actions">
          <button class="btn-secondary" (click)="cargarFechas()">
            <i class="fas fa-sync-alt"></i>
            Actualizar
          </button>
        </div>
      </div>

      <div class="fechas-grid" *ngIf="fechasGlobales.length > 0; else noFechas">
        <div class="fecha-card" *ngFor="let fecha of fechasGlobales" [class]="'tipo-' + fecha.tipo_fecha">
          <div class="fecha-header">
            <div class="fecha-icon">
              <i [class]="getIconoTipoFecha(fecha.tipo_fecha)"></i>
            </div>
            <div class="fecha-info">
              <h3>{{fecha.titulo}}</h3>
              <p class="fecha-date">{{formatearFechaCompleta(fecha.fecha)}}</p>
            </div>
            <div class="fecha-actions">
              <button class="btn-edit" (click)="editarFecha(fecha)" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-delete" (click)="confirmarEliminar(fecha)" title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          
          <div class="fecha-details" *ngIf="fecha.descripcion">
            <p>{{fecha.descripcion}}</p>
          </div>
          
          <div class="fecha-meta">
            <span class="tipo-badge">{{getTipoFechaLabel(fecha.tipo_fecha)}}</span>
            <span class="creador">Creado por: {{fecha.nombre_creador}}</span>
            <span class="fecha-creacion">{{fecha.created_at | date:'short':'es-ES'}}</span>
          </div>
        </div>
      </div>

      <ng-template #noFechas>
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-calendar-times"></i>
          </div>
          <h3>No hay fechas globales</h3>
          <p>A√∫n no se han creado fechas globales en el sistema</p>
          <button class="btn-primary" (click)="mostrarFormulario = true">
            <i class="fas fa-plus"></i>
            Crear Primera Fecha
          </button>
        </div>
      </ng-template>
    </div>

    <!-- NUEVA SECCI√ìN: Calendario General de Fechas Importantes (Art√≠culos 29-32) -->
    <div class="calendario-general-section">
      <div class="section-header">
        <h2>
          <i class="fas fa-calendar-exclamation"></i> 
          Calendario General - Fechas Importantes de Proyectos
        </h2>
        <div class="section-actions">
          <button class="btn-secondary" (click)="cargarCalendarioGeneral()">
            <i class="fas fa-sync-alt"></i>
            Actualizar
          </button>
          <button class="btn-primary" (click)="generarAlertasManual()">
            <i class="fas fa-bell"></i>
            Generar Alertas
          </button>
        </div>
      </div>

      <div class="estadisticas-calendario" *ngIf="calendarioGeneral.estadisticas">
        <div class="stat-card danger">
          <div class="stat-icon"><i class="fas fa-exclamation-circle"></i></div>
          <div class="stat-content">
            <div class="stat-number">{{calendarioGeneral.estadisticas.vencidas}}</div>
            <div class="stat-label">Vencidas</div>
          </div>
        </div>
        <div class="stat-card warning">
          <div class="stat-icon"><i class="fas fa-clock"></i></div>
          <div class="stat-content">
            <div class="stat-number">{{calendarioGeneral.estadisticas.hoy}}</div>
            <div class="stat-label">Hoy</div>
          </div>
        </div>
        <div class="stat-card info">
          <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
          <div class="stat-content">
            <div class="stat-number">{{calendarioGeneral.estadisticas.pendientes}}</div>
            <div class="stat-label">Pendientes</div>
          </div>
        </div>
        <div class="stat-card success">
          <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
          <div class="stat-content">
            <div class="stat-number">{{calendarioGeneral.estadisticas.completadas}}</div>
            <div class="stat-label">Completadas</div>
          </div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="filtros-calendario">
        <select [(ngModel)]="filtroTipoFecha" class="form-select">
          <option value="">Todos los tipos</option>
          <option value="entrega_final">Entrega Final</option>
          <option value="defensa">Defensa</option>
          <option value="presentacion">Presentaci√≥n</option>
          <option value="entrega_avance">Entrega Avance</option>
          <option value="revision_parcial">Revisi√≥n Parcial</option>
        </select>

        <select [(ngModel)]="filtroEstadoFecha" class="form-select">
          <option value="">Todos los estados</option>
          <option value="vencida">Vencidas</option>
          <option value="hoy">Hoy</option>
          <option value="pendiente">Pendientes</option>
          <option value="completada">Completadas</option>
        </select>

        <button class="btn-clear-filters" (click)="limpiarFiltrosCalendario()" *ngIf="filtroTipoFecha || filtroEstadoFecha">
          <i class="fas fa-times"></i>
          Limpiar filtros
        </button>
      </div>

      <!-- Tabla de fechas importantes -->
      <div class="calendario-table-container" *ngIf="getFechasFiltradas().length > 0">
        <table class="calendario-table">
          <thead>
            <tr>
              <th>Fecha L√≠mite</th>
              <th>Tipo</th>
              <th>T√≠tulo</th>
              <th>Proyecto</th>
              <th>Estudiante</th>
              <th>Profesores</th>
              <th>Estado</th>
              <th>D√≠as Restantes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let fecha of getFechasFiltradas()" 
                [class]="'estado-' + fecha.estado">
              <td class="fecha-col">
                <i class="fas fa-calendar-day"></i>
                {{ formatearFechaCorta(fecha.fecha_limite) }}
              </td>
              <td>
                <span class="tipo-badge" [class]="'tipo-' + fecha.tipo_fecha">
                  {{ getTipoFechaLabel(fecha.tipo_fecha) }}
                </span>
              </td>
              <td class="titulo-col">{{ fecha.titulo }}</td>
              <td class="proyecto-col">{{ fecha.titulo_proyecto }}</td>
              <td class="estudiante-col">
                <i class="fas fa-user"></i>
                {{ fecha.nombre_estudiante }}
              </td>
              <td class="profesores-col">
                <i class="fas fa-user-tie"></i>
                {{ fecha.profesores_asignados || 'Sin asignar' }}
              </td>
              <td>
                <span class="estado-badge" [class]="'estado-' + fecha.estado">
                  {{ getEstadoLabel(fecha.estado) }}
                </span>
              </td>
              <td class="dias-col">
                <span class="dias-restantes" [class]="getDiasRestantesClase(fecha.dias_restantes)">
                  {{ formatearDiasRestantes(fecha.dias_restantes) }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="empty-calendario" *ngIf="getFechasFiltradas().length === 0 && !cargandoCalendario">
        <i class="fas fa-calendar-times"></i>
        <p>No hay fechas importantes que mostrar con los filtros aplicados</p>
      </div>

      <div class="loading-calendario" *ngIf="cargandoCalendario">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Cargando calendario general...</p>
      </div>
    </div>

    <!-- Bot√≥n volver m√≥vil -->
    <div class="volver-section mobile-only">
      <button class="btn-volver" (click)="volver()">
        <i class="fas fa-arrow-left"></i>
        Volver al Panel de Administraci√≥n
      </button>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>&copy; {{fechaActual() | date:'yyyy'}} Universidad del B√≠o-B√≠o - Sistema de Gesti√≥n de T√≠tulos</p>
  </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div class="modal-overlay" *ngIf="mostrarModalEliminar" (click)="cancelarEliminar()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Confirmar Eliminaci√≥n</h3>
      <button class="close-btn" (click)="cancelarEliminar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>¬øEst√°s seguro de que deseas eliminar la fecha "<strong>{{fechaAEliminar?.titulo}}</strong>"?</p>
      <p class="warning">Esta acci√≥n no se puede deshacer.</p>
    </div>
    <div class="modal-actions">
      <button class="btn-danger" (click)="eliminarFecha()" [disabled]="eliminando">
        <i class="fas fa-trash"></i>
        {{eliminando ? 'Eliminando...' : 'Eliminar'}}
      </button>
      <button class="btn-secondary" (click)="cancelarEliminar()">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
    </div>
  </div>
</div>