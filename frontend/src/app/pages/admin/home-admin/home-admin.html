<!-- Navbar del administrador -->
<nav class="navbar">
  <div class="navbar-brand">
    <i class="fas fa-graduation-cap"></i>
    <span>AcTitUBB</span>
  </div>
  
  <div class="navbar-actions">
    <!-- Notificaciones -->
    <div class="action-item notifications-menu" (click)="togglePanelNotificaciones()">
        <i class="fas fa-bell"></i>
        <span *ngIf="notificacionesNoLeidas > 0" class="notification-badge">{{ notificacionesNoLeidas }}</span>
      
      <!-- Panel desplegable de notificaciones -->
      <div *ngIf="mostrarPanelNotificaciones" class="dropdown-menu notifications-dropdown show">
        <div class="panel-header">
          <h3>Notificaciones</h3>
          <button class="btn-small" (click)="marcarTodasComoLeidas(); $event.stopPropagation()" *ngIf="notificacionesNoLeidas > 0">
            Marcar todas como leídas
          </button>
        </div>
        
        <div class="notifications-list" *ngIf="notificaciones.length > 0">
          <div *ngFor="let notificacion of notificaciones" 
               class="notification-item" 
               [class.no-leida]="!notificacion.leida"
               (click)="marcarComoLeida(notificacion); $event.stopPropagation()">
            <div class="notification-icon" [style.color]="obtenerColorNotificacion(notificacion.tipo)">
              <i [class]="obtenerIconoNotificacion(notificacion.tipo)"></i>
            </div>
            <div class="notification-content">
              <h4>{{ notificacion.titulo }}</h4>
              <p>{{ notificacion.mensaje }}</p>
              <span class="notification-time">{{ formatearTiempoNotificacion(notificacion.fecha) }}</span>
            </div>
            <button class="notification-close" (click)="eliminarNotificacion(notificacion.id); $event.stopPropagation()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <div *ngIf="notificaciones.length === 0" class="no-notifications">
          <i class="fas fa-bell-slash"></i>
          <p>No hay notificaciones</p>
        </div>
      </div>
    </div>

    <!-- Menú de usuario -->
    <div class="action-item user-menu" (click)="toggleUserMenu()">
      <i class="fas fa-user-circle"></i>
      <span>{{ userName || 'Administrador' }}</span>
      <i class="fas fa-chevron-down"></i>
      
      <div class="dropdown-menu" [class.show]="showUserMenu">
        <div class="dropdown-item" (click)="cerrarSesion()">
          <i class="fas fa-sign-out-alt"></i>
          <span>Cerrar Sesión</span>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- Contenido principal -->
<div class="main-container">
  <!-- Header con bienvenida -->
  <div class="welcome-header">
    <div class="welcome-content">
      <h1>Panel de Administración</h1>
      <p>Gestión completa del sistema de propuestas de título</p>
    </div>
    <div class="welcome-icon">
      <i class="fas fa-cogs"></i>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loadingDashboard" class="loading-state">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
    <p>Cargando estadísticas del sistema...</p>
  </div>

  <!-- Dashboard de Estadísticas Unificado -->
  @if (dashboard && !loadingDashboard) {
    <div class="analytics-section">
      <div class="section-title">
      <i class="fas fa-chart-bar"></i>
        <h2>Estadísticas del Sistema</h2>
      </div>
    
      <!-- Métricas Principales de Propuestas -->
      <div class="stats-grid-propuestas">
      <!-- Total de Propuestas -->
      <div class="stat-card primary">
        <div class="stat-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="stat-content">
            <h3>{{ dashboard.metricas_generales?.total_propuestas || 0 }}</h3>
          <p>Total de Propuestas</p>
        </div>
      </div>

      <!-- Propuestas Pendientes -->
      <div class="stat-card warning">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
            <h3>{{ dashboard.metricas_generales?.propuestas_pendientes || 0 }}</h3>
          <p>Pendientes</p>
        </div>
      </div>

      <!-- Propuestas en Revisión -->
      <div class="stat-card info">
        <div class="stat-icon">
          <i class="fas fa-search"></i>
        </div>
        <div class="stat-content">
            <h3>{{ dashboard.metricas_generales?.propuestas_en_revision || 0 }}</h3>
          <p>En Revisión</p>
        </div>
      </div>

      <!-- Propuestas Aprobadas -->
      <div class="stat-card success">
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <h3>{{ dashboard.metricas_generales?.propuestas_aprobadas || 0 }}</h3>
          <p>Aprobadas</p>
        </div>
      </div>
      </div>

      <!-- Métricas Generales -->
      <div class="metricas-generales">
        <div class="subsection-title">
          <i class="fas fa-tachometer-alt"></i>
          <h3>Métricas Generales</h3>
        </div>
        
        <div class="metricas-grid">
          <div class="metrica-card estudiantes">
            <div class="metrica-icon">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div class="metrica-content">
              <h4>{{ dashboard.metricas_generales?.total_estudiantes || 0 }}</h4>
              <p>Estudiantes</p>
            </div>
          </div>
          
          <div class="metrica-card profesores">
            <div class="metrica-icon">
              <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="metrica-content">
              <h4>{{ dashboard.metricas_generales?.total_profesores || 0 }}</h4>
              <p>Profesores</p>
            </div>
          </div>
          
          <div class="metrica-card proyectos">
            <div class="metrica-icon">
              <i class="fas fa-folder-open"></i>
            </div>
            <div class="metrica-content">
              <h4>{{ dashboard.metricas_generales?.total_proyectos_activos || 0 }}</h4>
              <p>Proyectos Activos</p>
            </div>
          </div>
          
          <div class="metrica-card rechazadas">
            <div class="metrica-icon">
              <i class="fas fa-times-circle"></i>
            </div>
            <div class="metrica-content">
              <h4>{{ dashboard.metricas_generales?.propuestas_rechazadas || 0 }}</h4>
              <p>Propuestas Rechazadas</p>
            </div>
          </div>
          
          <div class="metrica-card avance">
            <div class="metrica-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="metrica-content">
              <h4>{{ dashboard.metricas_generales?.avance_promedio_proyectos || 0 }}%</h4>
              <p>Avance Promedio</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Propuestas y Proyectos por Estado -->
      <div class="estados-section">
        <div class="subsection-title">
          <i class="fas fa-list-alt"></i>
          <h3>Distribución por Estados</h3>
        </div>
        
        <div class="estados-grid">
          <!-- Propuestas por Estado -->
          <div class="estados-card">
            <h4>
              <i class="fas fa-file-alt"></i>
              Propuestas por Estado
            </h4>
            <div class="estados-list">
              @for (estado of dashboard.propuestas_por_estado; track estado.estado) {
                <div class="estado-item">
                  <div class="estado-bar">
                    <div class="estado-label">
                      <span class="estado-nombre">{{ estado.estado }}</span>
                      <span class="estado-count">{{ estado.total }}</span>
                    </div>
                    <div class="bar-container">
                      <div class="bar-fill" 
                           [style.width.%]="(estado.total / dashboard.metricas_generales.total_estudiantes * 100)"
                           [class]="'estado-' + estado.estado"></div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
          
          <!-- Proyectos por Estado -->
          <div class="estados-card">
            <h4>
              <i class="fas fa-project-diagram"></i>
              Proyectos por Estado
            </h4>
            <div class="estados-list">
              @for (estado of dashboard.proyectos_por_estado; track estado.estado_proyecto) {
                <div class="estado-item">
                  <div class="estado-bar">
                    <div class="estado-label">
                      <span class="estado-nombre">{{ estado.estado_proyecto }}</span>
                      <span class="estado-count">{{ estado.total }}</span>
                    </div>
                    <div class="bar-container">
                      <div class="bar-fill" 
                           [style.width.%]="(estado.total / dashboard.metricas_generales.total_proyectos_activos * 100)"
                           [class]="'estado-' + estado.estado_proyecto"></div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Distribución por Modalidad -->
      @if (dashboard.distribucion_modalidad && dashboard.distribucion_modalidad.length > 0) {
        <div class="modalidad-section">
          <div class="subsection-title">
            <i class="fas fa-layer-group"></i>
            <h3>Distribución por Modalidad de Proyecto</h3>
          </div>
          
          <div class="modalidad-grid">
            @for (modalidad of dashboard.distribucion_modalidad; track modalidad.modalidad) {
              <div class="modalidad-card">
                <div class="modalidad-header">
                  <div class="modalidad-icon">
                    @if (modalidad.modalidad === 'proyecto_investigacion') {
                      <i class="fas fa-flask"></i>
                    } @else if (modalidad.modalidad === 'tesis') {
                      <i class="fas fa-graduation-cap"></i>
                    } @else if (modalidad.modalidad === 'proyecto_profesional') {
                      <i class="fas fa-briefcase"></i>
                    } @else {
                      <i class="fas fa-file"></i>
                    }
                  </div>
                  <h4>{{ modalidad.modalidad }}</h4>
                </div>
                <div class="modalidad-stats">
                  <div class="stat-row">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">{{ modalidad.total }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="stat-label">Avance:</span>
                    <span class="stat-value">{{ modalidad.avance_promedio || 0 }}%</span>
                  </div>
                </div>
                <div class="modalidad-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="modalidad.avance_promedio || 0"></div>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Tiempos de Revisión de Propuestas -->
      @if (dashboard.tiempos_revision_propuestas && dashboard.tiempos_revision_propuestas.length > 0) {
        <div class="tiempos-revision-section">
          <div class="subsection-title">
            <i class="fas fa-clock"></i>
            <h3>Tiempos Promedio de Revisión (Últimos 6 Meses)</h3>
          </div>
          
          <div class="tiempos-table-wrapper">
            <table class="tiempos-table">
              <thead>
                <tr>
                  <th>Mes</th>
                  <th>Propuestas Revisadas</th>
                  <th>Tiempo Promedio (días)</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                @for (tiempo of dashboard.tiempos_revision_propuestas; track tiempo.mes) {
                  <tr>
                    <td class="mes-col">
                      <i class="fas fa-calendar"></i>
                      {{ tiempo.mes }}
                    </td>
                    <td class="cantidad-col">{{ tiempo.propuestas_revisadas }}</td>
                    <td class="tiempo-col">
                      <span class="tiempo-badge" 
                            [class.rapido]="tiempo.promedio_dias_revision <= 5"
                            [class.normal]="tiempo.promedio_dias_revision > 5 && tiempo.promedio_dias_revision <= 10"
                            [class.lento]="tiempo.promedio_dias_revision > 10">
                        {{ tiempo.promedio_dias_revision }} días
                      </span>
                    </td>
                    <td class="estado-col">
                      @if (tiempo.promedio_dias_revision <= 5) {
                        <span class="estado-badge excelente">
                          <i class="fas fa-bolt"></i>
                          Excelente
                        </span>
                      } @else if (tiempo.promedio_dias_revision <= 10) {
                        <span class="estado-badge bueno">
                          <i class="fas fa-check"></i>
                          Bueno
                        </span>
                      } @else {
                        <span class="estado-badge mejorable">
                          <i class="fas fa-exclamation-triangle"></i>
                          Mejorable
                        </span>
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      }

      <!-- Tendencias Mensuales -->
      @if (dashboard.tendencias_mensuales && dashboard.tendencias_mensuales.length > 0) {
        <div class="tendencias-section">
          <div class="subsection-title">
            <i class="fas fa-chart-area"></i>
            <h3>Tendencias de Actividad (Últimos 6 Meses)</h3>
          </div>
          
          <div class="tendencias-chart">
            @for (mes of dashboard.tendencias_mensuales; track mes.mes) {
              <div class="chart-bar-group">
                <div class="chart-bars">
                  <div class="chart-bar propuestas-bar" 
                       [style.height.%]="(mes.propuestas_creadas / 10 * 100)"
                       [title]="mes.propuestas_creadas + ' propuestas'">
                    <span class="bar-value">{{ mes.propuestas_creadas }}</span>
                  </div>
                  <div class="chart-bar proyectos-bar" 
                       [style.height.%]="(mes.proyectos_creados / 10 * 100)"
                       [title]="mes.proyectos_creados + ' proyectos'">
                    <span class="bar-value">{{ mes.proyectos_creados }}</span>
                  </div>
                </div>
                <div class="chart-label">{{ mes.mes }}</div>
              </div>
            }
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <div class="legend-color propuestas"></div>
              <span>Propuestas Creadas</span>
            </div>
            <div class="legend-item">
              <div class="legend-color proyectos"></div>
              <span>Proyectos Creados</span>
            </div>
          </div>
        </div>
      }

      <!-- Carga de Profesores (Top 10) -->
      @if (dashboard.carga_profesores && dashboard.carga_profesores.length > 0) {
        <div class="carga-profesores-section">
          <div class="subsection-title">
            <i class="fas fa-users-cog"></i>
            <h3>Carga de Profesores (Top 10)</h3>
          </div>
          
          <div class="profesores-list">
            @for (profesor of dashboard.carga_profesores; track profesor.rut; let i = $index) {
              <div class="profesor-item" [class.top3]="i < 3">
                <div class="profesor-rank">
                  @if (i === 0) {
                    <i class="fas fa-trophy" style="color: #FFD700;"></i>
                  } @else if (i === 1) {
                    <i class="fas fa-trophy" style="color: #C0C0C0;"></i>
                  } @else if (i === 2) {
                    <i class="fas fa-trophy" style="color: #CD7F32;"></i>
                  } @else {
                    <span class="rank-number">{{ i + 1 }}</span>
                  }
                </div>
                <div class="profesor-info">
                  <h4>{{ profesor.nombre }}</h4>
                  <p class="profesor-email">{{ profesor.correo }}</p>
                </div>
                <div class="profesor-stats">
                  <div class="stat-pill">
                    <i class="fas fa-graduation-cap"></i>
                    {{ profesor.proyectos_guia }} Guía
                  </div>
                  <div class="stat-pill">
                    <i class="fas fa-user-check"></i>
                    {{ profesor.proyectos_informante }} Informante
                  </div>
                  <div class="stat-pill total">
                    <i class="fas fa-folder"></i>
                    {{ profesor.total_proyectos }} Total
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Secciones de administración -->
  <div class="admin-sections">
    <h2 class="section-title">
      <i class="fas fa-tools"></i>
      Herramientas de Administración
    </h2>
    
    <div class="sections-grid">
      <!-- Gestión de Propuestas -->
      <div class="section-card" (click)="irAGestionPropuestas()">
        <div class="card-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="card-content">
          <h3>Gestión de Propuestas</h3>
          <p>Ver, editar y administrar todas las propuestas del sistema</p>
          <div class="card-actions">
            <span class="action-text">Acceder</span>
            <i class="fas fa-arrow-right"></i>
          </div>
        </div>
      </div>

      <!-- Gestión de Usuarios -->
      <div class="section-card" (click)="irAGestionUsuarios()">
        <div class="card-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="card-content">
          <h3>Gestión de Usuarios</h3>
          <p>Administrar estudiantes, profesores y roles del sistema</p>
          <div class="card-actions">
            <span class="action-text">Acceder</span>
            <i class="fas fa-arrow-right"></i>
          </div>
        </div>
      </div>


      <!-- Asignaciones -->
      <div class="section-card" (click)="irAAsignaciones()">
        <div class="card-icon">
          <i class="fas fa-user-plus"></i>
        </div>
        <div class="card-content">
          <h3>Asignaciones</h3>
          <p>Asignar profesores a propuestas y gestionar responsabilidades</p>
          <div class="card-actions">
            <span class="action-text">Acceder</span>
            <i class="fas fa-arrow-right"></i>
          </div>
        </div>
      </div>

      <!-- Sistema de Calendario Unificado -->
      <div class="section-card calendar-unified-card" (click)="irACalendarioUnificado()">
        <div class="card-icon">
          <i class="fas fa-calendar"></i>
        </div>
        <div class="card-content">
          <h3>Sistema de Calendario</h3>
          <p>Gestión completa: fechas globales, propuestas, proyectos y reuniones</p>
          <div class="card-badges">
            <span class="badge"><i class="fas fa-calendar-alt"></i> Eventos</span>
            <span class="badge"><i class="fas fa-calendar-check"></i> Propuestas</span>
            <span class="badge"><i class="fas fa-calendar-day"></i> Proyectos</span>
            <span class="badge"><i class="fas fa-handshake"></i> Reuniones</span>
          </div>
          <div class="card-actions">
            <span class="action-text">Acceder al Sistema</span>
            <i class="fas fa-arrow-right"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="main-footer">
  <div class="footer-content">
    <p>&copy; {{fechaActual() | date:'yyyy'}} Universidad del Bío-Bío - Panel de Administración</p>
  </div>
</footer> 