<div class="asignaciones-container">
  <div class="header">
    <div class="header-content">
      <h1><i class="fas fa-users-cog"></i> Gestión de Roles de Profesores</h1>
      <p>Administra las asignaciones de profesores a proyectos</p>
    </div>
    <div class="header-actions">
      <button (click)="volver()">
        <i class="fas fa-arrow-left"></i>
        Volver
      </button>
      <button (click)="mostrarFormularioAsignacion()">
        <i class="fas fa-plus"></i>
        Nueva Asignación
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <h3>Cargando asignaciones...</h3>
    <p>Obteniendo información de todas las asignaciones registradas</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <i class="fas fa-exclamation-triangle"></i>
    <h3>Error al cargar las asignaciones</h3>
    <p>{{ error }}</p>
    <button class="btn-primary" (click)="cargarAsignaciones()">
      <i class="fas fa-redo"></i>
      Intentar de nuevo
    </button>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!loading && !error">
    <!-- Tabs de navegación -->
    <div class="tabs-container">
      <div class="tabs-nav">
        <button 
          class="tab-btn" 
          [class.active]="tabActiva === 'asignaciones'"
          (click)="cambiarTab('asignaciones')">
          <i class="fas fa-users"></i>
          Asignaciones Activas
        </button>
        <button 
          class="tab-btn" 
          [class.active]="tabActiva === 'proyectos'"
          (click)="cambiarTab('proyectos')">
          <i class="fas fa-project-diagram"></i>
          Vista por Proyectos
        </button>
        <button 
          class="tab-btn" 
          [class.active]="tabActiva === 'estadisticas'"
          (click)="cambiarTab('estadisticas')">
          <i class="fas fa-chart-bar"></i>
          Estadísticas
        </button>
        <button 
          class="tab-btn" 
          [class.active]="tabActiva === 'historial'"
          (click)="cambiarTab('historial')">
          <i class="fas fa-history"></i>
          Historial
        </button>
      </div>
    </div>

    <!-- Modal para nueva asignación -->
    <div *ngIf="mostrarFormulario" class="modal-overlay" (click)="ocultarFormularioAsignacion()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3><i class="fas fa-user-plus"></i> Nueva Asignación de Rol</h3>
          <button class="btn-close" (click)="ocultarFormularioAsignacion()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="crearAsignacion()">
            <div class="form-group">
              <label for="proyecto">Proyecto *</label>
              <select id="proyecto" [(ngModel)]="nuevaAsignacion.proyecto_id" name="proyecto" required>
                <option value="">Seleccionar proyecto</option>
                <option *ngFor="let proyecto of proyectos" [value]="proyecto.proyecto_id || proyecto.id">
                  {{proyecto.titulo}}
                </option>
              </select>
              <small *ngIf="proyectos.length === 0" class="text-warning">
                ⚠️ No hay proyectos disponibles
              </small>
            </div>
            
            <div class="form-group">
              <label for="profesor">Profesor *</label>
              <select id="profesor" [(ngModel)]="nuevaAsignacion.profesor_rut" name="profesor" required>
                <option value="">Seleccionar profesor</option>
                <option *ngFor="let profesor of profesores" [value]="profesor.rut">
                  {{profesor.nombre}} ({{profesor.email}})
                </option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="rol">Rol *</label>
              <select id="rol" [(ngModel)]="nuevaAsignacion.rol_profesor_id" name="rol" required>
                <option value="">Seleccionar rol</option>
                <option *ngFor="let rol of rolesProfesores" [value]="rol.id">
                  {{rol.nombre}}
                </option>
              </select>
              <small *ngIf="rolesProfesores.length === 0" class="text-warning">
                ⚠️ No se pudieron cargar los roles. Total: {{rolesProfesores.length}}
              </small>
            </div>
            
            <div class="form-group">
              <label for="observaciones">Observaciones</label>
              <textarea 
                id="observaciones" 
                [(ngModel)]="nuevaAsignacion.observaciones" 
                name="observaciones"
                placeholder="Observaciones sobre la asignación (opcional)"
                rows="3">
              </textarea>
            </div>
            
            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="ocultarFormularioAsignacion()">
                Cancelar
              </button>
              <button type="submit" class="btn-primary">
                <i class="fas fa-plus"></i>
                Crear Asignación
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- TAB ASIGNACIONES -->
    <div *ngIf="tabActiva === 'asignaciones'">
      <!-- Filtros -->
      <div class="filtros-section">
        <h3><i class="fas fa-filter"></i> Filtros de Búsqueda</h3>
        <div class="filtros-grid">
          <div class="filtro-grupo">
            <label for="filtroProfesor">Profesor:</label>
            <input 
              type="text" 
              id="filtroProfesor" 
              [(ngModel)]="filtroProfesor" 
              placeholder="Buscar por nombre de profesor"
            />
          </div>
          
          <div class="filtro-grupo">
            <label for="filtroEstudiante">Proyecto:</label>
            <input 
              type="text" 
              id="filtroEstudiante" 
              [(ngModel)]="filtroEstudiante" 
              placeholder="Buscar por título de proyecto"
            />
          </div>
          
          <div class="filtro-grupo">
            <label for="filtroRol">Rol:</label>
            <select id="filtroRol" [(ngModel)]="filtroRol">
              <option value="">Todos los roles</option>
              <option *ngFor="let rol of rolesProfesores" [value]="rol.nombre">
                {{rol.descripcion}}
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Lista de asignaciones -->
      <div class="asignaciones-list">
        <div *ngIf="filtrarAsignaciones().length === 0" class="no-results">
          <i class="fas fa-search"></i>
          <h3>No se encontraron asignaciones</h3>
          <p>No hay asignaciones que coincidan con los filtros seleccionados</p>
        </div>

        <div *ngFor="let asignacion of filtrarAsignaciones()" class="asignacion-card">
          <div class="asignacion-header">
            <div class="asignacion-info">
              <h4>{{asignacion.profesor_nombre}}</h4>
              <span 
                class="rol-badge" 
                [style.background-color]="getRolColor(asignacion.rol_nombre)">
                {{asignacion.rol_descripcion}}
              </span>
            </div>
            <div class="asignacion-actions">
              <button 
                class="btn-danger-small" 
                (click)="desasignarProfesor(asignacion); $event.stopPropagation()"
                [disabled]="loadingAsignacion"
                title="Desasignar profesor">
                <i class="fas fa-user-minus"></i>
              </button>
            </div>
          </div>
          
          <div class="asignacion-body">
            <div class="asignacion-details">
              <div class="detail-item">
                <strong>Proyecto:</strong> {{asignacion.proyecto_titulo || 'Sin título'}}
              </div>
              <div class="detail-item">
                <strong>Email:</strong> {{asignacion.profesor_email}}
              </div>
              <div class="detail-item">
                <strong>Fecha de asignación:</strong> {{formatearFecha(asignacion.fecha_asignacion)}}
              </div>
              <div class="detail-item" *ngIf="asignacion.observaciones">
                <strong>Observaciones:</strong> {{asignacion.observaciones}}
              </div>
              <div class="detail-item">
                <strong>Asignado por:</strong> {{asignacion.asignado_por_nombre || 'N/A'}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB PROYECTOS -->
    <div *ngIf="tabActiva === 'proyectos'">
      <!-- Filtros para proyectos -->
      <div class="filtros-section">
        <h3><i class="fas fa-filter"></i> Filtros de Proyectos</h3>
        <div class="filtros-grid">
          <div class="filtro-grupo">
            <label for="filtroProyectos">Buscar Proyecto:</label>
            <input 
              type="text" 
              id="filtroProyectos" 
              [(ngModel)]="filtroProyectos" 
              (ngModelChange)="aplicarFiltroProyectos()"
              placeholder="Buscar por título, descripción o estudiante"
            />
          </div>
          
          <div class="filtro-grupo">
            <label for="filtroEstadoProyecto">Estado:</label>
            <select id="filtroEstadoProyecto" [(ngModel)]="filtroEstadoProyecto" (ngModelChange)="aplicarFiltroProyectos()">
              <option value="">Todos los estados</option>
              <option value="propuesta">Propuesta</option>
              <option value="en_desarrollo">En Desarrollo</option>
              <option value="en_revision">En Revisión</option>
              <option value="finalizado">Finalizado</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Lista de proyectos -->
      <div class="proyectos-grid">
        <div *ngIf="proyectosFiltrados.length === 0" class="no-results">
          <i class="fas fa-project-diagram"></i>
          <h3>No se encontraron proyectos</h3>
          <p>No hay proyectos que coincidan con los filtros seleccionados</p>
        </div>

        <div *ngFor="let proyecto of proyectosFiltrados" class="proyecto-card">
          <div class="proyecto-header">
            <div class="proyecto-info">
              <h4>{{proyecto.titulo || 'Sin título'}}</h4>
              <span 
                class="estado-badge" 
                [class]="obtenerClaseEstado(proyecto.estado)">
                {{getEstadoDisplay(proyecto.estado)}}
              </span>
            </div>
            <div class="proyecto-actions">
              <button 
                class="btn-primary-small" 
                (click)="verAsignacionesProyecto(proyecto)"
                title="Ver asignaciones del proyecto">
                <i class="fas fa-eye"></i>
                Ver Asignaciones
              </button>
              <button 
                class="btn-success-small" 
                (click)="asignarProfesorAProyecto(proyecto)"
                title="Asignar profesor al proyecto">
                <i class="fas fa-user-plus"></i>
                Asignar
              </button>
            </div>
          </div>
          
          <div class="proyecto-body">
            <div class="proyecto-details">
              <div class="detail-item">
                <strong>Estudiante:</strong> {{proyecto.estudiante_nombre || 'No asignado'}}
              </div>
              <div class="detail-item">
                <strong>Descripción:</strong> 
                <span class="descripcion-texto">{{proyecto.descripcion || 'Sin descripción'}}</span>
              </div>
              <div class="detail-item">
                <strong>Fecha de creación:</strong> {{formatearFecha(proyecto.fecha_creacion)}}
              </div>
              <div class="detail-item">
                <strong>Profesores asignados:</strong> 
                <span class="profesores-count">{{contarAsignacionesProyecto(proyecto.id)}} profesor(es)</span>
              </div>
            </div>
            
            <!-- Asignaciones resumidas -->
            <div class="asignaciones-resumen" *ngIf="getAsignacionesProyecto(proyecto.id).length > 0">
              <h5><i class="fas fa-users"></i> Profesores Asignados:</h5>
              <div class="profesores-lista">
                <div 
                  *ngFor="let asignacion of getAsignacionesProyecto(proyecto.id).slice(0, 3)" 
                  class="profesor-item">
                  <span class="profesor-nombre">{{asignacion.profesor_nombre}}</span>
                  <span 
                    class="rol-badge-small" 
                    [style.background-color]="getRolColor(asignacion.rol_nombre)">
                    {{formatRolName(asignacion.rol_nombre)}}
                  </span>
                </div>
                <div *ngIf="getAsignacionesProyecto(proyecto.id).length > 3" class="mas-profesores">
                  +{{getAsignacionesProyecto(proyecto.id).length - 3}} más...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para ver asignaciones por proyecto -->
    <div *ngIf="mostrarModalProyecto" class="modal-overlay" (click)="cerrarModalProyecto()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            <i class="fas fa-project-diagram"></i> 
            Asignaciones del Proyecto: {{proyectoSeleccionado?.titulo}}
          </h3>
          <button class="btn-close" (click)="cerrarModalProyecto()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="proyecto-info-modal">
            <div class="info-grid">
              <div class="info-item">
                <strong>Estudiante:</strong> {{proyectoSeleccionado?.estudiante_nombre || 'No asignado'}}
              </div>
              <div class="info-item">
                <strong>Estado:</strong>
                <span 
                  class="estado-badge" 
                  [class]="obtenerClaseEstado(proyectoSeleccionado?.estado)">
                  {{getEstadoDisplay(proyectoSeleccionado?.estado)}}
                </span>
              </div>
              <div class="info-item">
                <strong>Fecha de creación:</strong> {{formatearFecha(proyectoSeleccionado?.fecha_creacion)}}
              </div>
            </div>
          </div>

          <div class="asignaciones-proyecto-lista">
            <div class="lista-header">
              <h4><i class="fas fa-users"></i> Profesores Asignados ({{asignacionesProyecto.length}})</h4>
              <button 
                class="btn-primary-small" 
                (click)="asignarProfesorAProyecto(proyectoSeleccionado)">
                <i class="fas fa-user-plus"></i>
                Asignar Profesor
              </button>
            </div>

            <div *ngIf="asignacionesProyecto.length === 0" class="no-asignaciones">
              <i class="fas fa-user-slash"></i>
              <h4>No hay profesores asignados</h4>
              <p>Este proyecto aún no tiene profesores asignados. Haz clic en "Asignar Profesor" para comenzar.</p>
            </div>

            <div *ngFor="let asignacion of asignacionesProyecto" class="asignacion-item-modal">
              <div class="asignacion-info">
                <div class="profesor-datos">
                  <h5>{{asignacion.profesor_nombre}}</h5>
                  <p class="profesor-email">{{asignacion.profesor_email}}</p>
                </div>
                <div class="rol-info">
                  <span 
                    class="rol-badge" 
                    [style.background-color]="getRolColor(asignacion.rol_nombre)">
                    {{formatRolName(asignacion.rol_nombre)}}
                  </span>
                </div>
              </div>
              <div class="asignacion-meta">
                <div class="meta-item">
                  <small><strong>Asignado:</strong> {{formatearFecha(asignacion.fecha_asignacion)}}</small>
                </div>
                <div class="meta-item" *ngIf="asignacion.observaciones">
                  <small><strong>Observaciones:</strong> {{asignacion.observaciones}}</small>
                </div>
                <div class="meta-item">
                  <small><strong>Por:</strong> {{asignacion.asignado_por_nombre || 'Sistema'}}</small>
                </div>
              </div>
              <div class="asignacion-actions">
                <button 
                  class="btn-danger-small" 
                  (click)="desasignarProfesor(asignacion); $event.stopPropagation()"
                  [disabled]="loadingAsignacion"
                  title="Desasignar profesor">
                  <i class="fas fa-user-minus"></i>
                  Desasignar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB ESTADÍSTICAS -->
    <div *ngIf="tabActiva === 'estadisticas'" class="estadisticas-section">
      <div *ngIf="estadisticasAsignaciones" class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-project-diagram"></i>
          </div>
          <div class="stat-content">
            <h3>{{estadisticasAsignaciones.totales?.total_proyectos_asignados || 0}}</h3>
            <p>Proyectos con Asignaciones</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-content">
            <h3>{{estadisticasAsignaciones.totales?.total_profesores_activos || 0}}</h3>
            <p>Profesores Activos</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-user-tag"></i>
          </div>
          <div class="stat-content">
            <h3>{{estadisticasAsignaciones.totales?.total_asignaciones_activas || 0}}</h3>
            <p>Asignaciones Activas</p>
          </div>
        </div>
      </div>

      <div class="roles-distribution">
        <h3><i class="fas fa-chart-pie"></i> Distribución por Roles</h3>
        <div class="roles-list">
          <div 
            *ngFor="let rol of estadisticasAsignaciones.por_roles" 
            class="rol-stat">
            <span 
              class="rol-badge" 
              [style.background-color]="getRolColor(rol.rol_nombre)">
              {{rol.rol_nombre.replace('profesor_', '').replace('_', ' ') | titlecase}}
            </span>
            <span class="rol-count">{{rol.asignaciones_por_rol}} asignaciones</span>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB HISTORIAL -->
    <div *ngIf="tabActiva === 'historial'" class="historial-section">
      <div class="historial-list">
        <div *ngIf="historialAsignaciones.length === 0" class="no-results">
          <i class="fas fa-history"></i>
          <h3>No hay historial disponible</h3>
          <p>No se han registrado cambios en las asignaciones</p>
        </div>

        <div *ngFor="let entrada of historialAsignaciones" class="historial-item">
          <div class="historial-icon" [class]="'accion-' + entrada.accion">
            <i class="fas" 
               [class.fa-plus]="entrada.accion === 'asignado'"
               [class.fa-minus]="entrada.accion === 'desasignado'"
               [class.fa-edit]="entrada.accion === 'modificado'">
            </i>
          </div>
          
          <div class="historial-content">
            <div class="historial-header">
              <strong>{{entrada.profesor_nombre}}</strong>
              <span class="accion-text">{{entrada.accion}}</span>
              <span>como</span>
              <span class="rol-name">{{entrada.rol_nombre.replace('profesor_', '').replace('_', ' ') | titlecase}}</span>
            </div>
            <div class="historial-details">
              <span>Proyecto: {{entrada.proyecto_titulo}}</span>
              <span>Por: {{entrada.realizado_por_nombre}}</span>
              <span>{{formatearFecha(entrada.fecha_accion)}}</span>
            </div>
            <div *ngIf="entrada.observaciones" class="historial-observaciones">
              <em>{{entrada.observaciones}}</em>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Botón de volver móvil -->
    <div class="volver-section mobile-only">
      <button class="btn-volver" (click)="volver()">
        <i class="fas fa-arrow-left"></i>
        Volver al Panel de Administración
      </button>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>&copy; {{getCurrentYear()}} Universidad del Bío-Bío. Sistema de Gestión de Títulos.</p>
  </div>
</div>