<!-- Contenedor principal -->
<div class="asignaciones-container">
  <!-- Header principal -->
  <div class="header">
    <div class="header-content">
      <h1><i class="fas fa-users-cog"></i> Gestión de Roles de Profesores</h1>
      <p>Administra las asignaciones de profesores a proyectos con roles específicos</p>
    </div>
    <div class="header-actions">
      <button class="btn-volver-header" (click)="volver()">
        <i class="fas fa-arrow-left"></i>
        Volver
      </button>
      <button class="btn-primary" (click)="mostrarFormularioAsignacion()">
        <i class="fas fa-plus"></i>
        Nueva Asignación
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <h3>Cargando asignaciones...</h3>
    <p>Obteniendo información de todas las asignaciones registradas</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <i class="fas fa-exclamation-triangle"></i>
    <h3>Error al cargar las asignaciones</h3>
    <p>{{ error }}</p>
    <button class="btn-primary" (click)="cargarAsignaciones()">
      <i class="fas fa-redo"></i>
      Intentar de nuevo
    </button>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!loading && !error">
    <!-- Tabs de navegación -->
    <div class="tabs-container">
      <div class="tabs-nav">
        <button 
          class="tab-btn" 
          [class.active]="tabActiva === 'asignaciones'"
          (click)="cambiarTab('asignaciones')">
          <i class="fas fa-users"></i>
          Asignaciones Activas
        </button>
        <button 
          class="tab-btn" 
          [class.active]="tabActiva === 'proyectos'"
          (click)="cambiarTab('proyectos')">
          <i class="fas fa-project-diagram"></i>
          Proyectos
        </button>
        <button 
          class="tab-btn" 
          [class.active]="tabActiva === 'estadisticas'"
          (click)="cambiarTab('estadisticas')">
          <i class="fas fa-chart-bar"></i>
          Estadísticas
        </button>
        <button 
          class="tab-btn" 
          [class.active]="tabActiva === 'historial'"
          (click)="cambiarTab('historial')">
          <i class="fas fa-history"></i>
          Historial
        </button>
      </div>
    </div>

    <!-- Modal para nueva asignación -->
    <div *ngIf="mostrarFormulario" class="modal-overlay" (click)="ocultarFormularioAsignacion()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3><i class="fas fa-user-plus"></i> Nueva Asignación de Rol</h3>
          <button class="btn-close" (click)="ocultarFormularioAsignacion()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="crearAsignacion()">
            <div class="form-group">
              <label for="proyecto">Proyecto *</label>
              <select id="proyecto" [(ngModel)]="nuevaAsignacion.proyecto_id" name="proyecto" required>
                <option value="">Seleccionar proyecto</option>
                <option *ngFor="let proyecto of proyectos" [value]="proyecto.proyecto_id">
                  {{proyecto.titulo}}
                </option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="profesor">Profesor *</label>
              <select id="profesor" [(ngModel)]="nuevaAsignacion.profesor_rut" name="profesor" required>
                <option value="">Seleccionar profesor</option>
                <option *ngFor="let profesor of profesores" [value]="profesor.rut">
                  {{profesor.nombre}} ({{profesor.email}})
                </option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="rol">Rol *</label>
              <select id="rol" [(ngModel)]="nuevaAsignacion.rol_profesor_id" name="rol" required>
                <option value="">Seleccionar rol</option>
                <option *ngFor="let rol of rolesProfesores" [value]="rol.id">
                  {{rol.descripcion}}
                </option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="observaciones">Observaciones</label>
              <textarea 
                id="observaciones" 
                [(ngModel)]="nuevaAsignacion.observaciones" 
                name="observaciones"
                placeholder="Observaciones sobre la asignación (opcional)"
                rows="3">
              </textarea>
            </div>
            
            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="ocultarFormularioAsignacion()">
                Cancelar
              </button>
              <button type="submit" class="btn-primary" [disabled]="loadingAsignacion">
                <i class="fas fa-spinner fa-spin" *ngIf="loadingAsignacion"></i>
                <i class="fas fa-plus" *ngIf="!loadingAsignacion"></i>
                {{ loadingAsignacion ? 'Creando...' : 'Crear Asignación' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para ver asignaciones por proyecto -->
    <div *ngIf="mostrarModalProyecto" class="modal-overlay" (click)="cerrarModalProyecto()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            <i class="fas fa-project-diagram"></i> 
            Asignaciones del Proyecto: {{ proyectoSeleccionado?.titulo }}
          </h3>
          <button class="btn-close" (click)="cerrarModalProyecto()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="proyecto-info">
            <div class="proyecto-meta">
              <div class="meta-item">
                <strong>Estudiante:</strong> {{ proyectoSeleccionado?.estudiante_nombre || 'No asignado' }}
              </div>
              <div class="meta-item">
                <strong>Estado:</strong> 
                <span [ngClass]="obtenerClaseEstado(proyectoSeleccionado?.estado)">
                  {{ proyectoSeleccionado?.estado || 'Sin estado' }}
                </span>
              </div>
              <div class="meta-item">
                <strong>Progreso:</strong> {{ proyectoSeleccionado?.progreso || 0 }}%
              </div>
            </div>
          </div>

          <div class="asignaciones-proyecto">
            <h4><i class="fas fa-users-cog"></i> Roles Asignados</h4>
            
            <div *ngIf="asignacionesProyecto.length === 0" class="no-asignaciones">
              <i class="fas fa-user-slash"></i>
              <p>No hay profesores asignados a este proyecto</p>
              <button class="btn-primary" (click)="cerrarModalProyecto(); mostrarFormularioAsignacion()">
                <i class="fas fa-plus"></i>
                Asignar Primer Profesor
              </button>
            </div>

            <div *ngFor="let asignacion of asignacionesProyecto" class="asignacion-proyecto-item">
              <div class="asignacion-profesor">
                <div class="profesor-avatar">
                  <i class="fas fa-user-tie"></i>
                </div>
                <div class="profesor-info">
                  <h5>{{ asignacion.profesor_nombre }}</h5>
                  <p>{{ asignacion.profesor_email }}</p>
                </div>
              </div>
              
              <div class="asignacion-rol">
                <span 
                  class="rol-badge-large" 
                  [style.background-color]="getRolColor(asignacion.rol_nombre)">
                  {{ asignacion.rol_descripcion }}
                </span>
              </div>
              
              <div class="asignacion-fecha">
                <small>Asignado el {{ formatearFecha(asignacion.fecha_asignacion) }}</small>
              </div>
              
              <div class="asignacion-acciones">
                <button 
                  class="btn-danger-small" 
                  (click)="desasignarProfesor(asignacion)"
                  title="Desasignar">
                  <i class="fas fa-user-minus"></i>
                </button>
              </div>
            </div>

            <div class="add-asignacion" *ngIf="asignacionesProyecto.length > 0">
              <button class="btn-secondary" (click)="cerrarModalProyecto(); mostrarFormularioAsignacion()">
                <i class="fas fa-plus"></i>
                Asignar Otro Profesor
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB ASIGNACIONES -->
    <div *ngIf="tabActiva === 'asignaciones'">
      <!-- Filtros -->
      <div class="filtros-section">
        <h3><i class="fas fa-filter"></i> Filtros de Búsqueda</h3>
        <div class="filtros-grid">
          <div class="filtro-grupo">
            <label for="filtroProfesor">Profesor:</label>
            <input 
              type="text" 
              id="filtroProfesor" 
              [(ngModel)]="filtroProfesor" 
              placeholder="Buscar por nombre de profesor"
            />
          </div>
          
          <div class="filtro-grupo">
            <label for="filtroEstudiante">Proyecto:</label>
            <input 
              type="text" 
              id="filtroEstudiante" 
              [(ngModel)]="filtroEstudiante" 
              placeholder="Buscar por título de proyecto"
            />
          </div>
          
          <div class="filtro-grupo">
            <label for="filtroRol">Rol:</label>
            <select id="filtroRol" [(ngModel)]="filtroRol">
              <option value="">Todos los roles</option>
              <option *ngFor="let rol of rolesProfesores" [value]="rol.nombre">
                {{rol.descripcion}}
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Lista de asignaciones -->
      <div class="asignaciones-list">
        <div *ngIf="filtrarAsignaciones().length === 0" class="no-results">
          <i class="fas fa-search"></i>
          <h3>No se encontraron asignaciones</h3>
          <p>No hay asignaciones que coincidan con los filtros seleccionados</p>
        </div>

        <div *ngFor="let asignacion of filtrarAsignaciones()" class="asignacion-card">
          <div class="asignacion-header">
            <div class="asignacion-info">
              <h4>{{asignacion.profesor_nombre}}</h4>
              <span 
                class="rol-badge" 
                [style.background-color]="getRolColor(asignacion.rol_nombre)">
                {{asignacion.rol_descripcion}}
              </span>
            </div>
            <div class="asignacion-actions">
              <button 
                class="btn-info-small" 
                (click)="verAsignacionesProyecto(asignacion)"
                title="Ver todas las asignaciones del proyecto">
                <i class="fas fa-users"></i>
              </button>
              <button 
                class="btn-danger-small" 
                (click)="desasignarProfesor(asignacion)"
                title="Desasignar profesor">
                <i class="fas fa-user-minus"></i>
              </button>
            </div>
          </div>
          
          <div class="asignacion-body">
            <div class="asignacion-details">
              <div class="detail-item">
                <strong>Proyecto:</strong> {{asignacion.proyecto_titulo || 'Sin título'}}
              </div>
              <div class="detail-item">
                <strong>Email:</strong> {{asignacion.profesor_email}}
              </div>
              <div class="detail-item">
                <strong>Fecha de asignación:</strong> {{formatearFecha(asignacion.fecha_asignacion)}}
              </div>
              <div class="detail-item" *ngIf="asignacion.observaciones">
                <strong>Observaciones:</strong> {{asignacion.observaciones}}
              </div>
              <div class="detail-item">
                <strong>Asignado por:</strong> {{asignacion.asignado_por_nombre || 'N/A'}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB PROYECTOS -->
    <div *ngIf="tabActiva === 'proyectos'" class="proyectos-section">
      <div class="proyectos-header">
        <h2><i class="fas fa-project-diagram"></i> Gestión de Proyectos</h2>
        <div class="proyectos-filters">
          <input 
            type="text" 
            class="filter-input"
            placeholder="Buscar proyectos..."
            [(ngModel)]="filtroProyectos"
            (input)="aplicarFiltroProyectos()">
          <select 
            class="filter-select"
            [(ngModel)]="filtroEstadoProyecto"
            (change)="aplicarFiltroProyectos()">
            <option value="">Todos los estados</option>
            <option value="propuesta">Propuesta</option>
            <option value="en_desarrollo">En Desarrollo</option>
            <option value="en_revision">En Revisión</option>
            <option value="finalizado">Finalizado</option>
          </select>
        </div>
      </div>

      <div *ngIf="proyectosFiltrados.length === 0" class="no-results">
        <i class="fas fa-project-diagram"></i>
        <h3>No hay proyectos disponibles</h3>
        <p>No se encontraron proyectos que coincidan con los filtros aplicados</p>
      </div>

      <div class="proyectos-grid">
        <div *ngFor="let proyecto of proyectosFiltrados" class="proyecto-card">
          <div class="proyecto-header">
            <div class="proyecto-info">
              <h3>{{proyecto.titulo}}</h3>
              <p class="proyecto-descripcion">{{proyecto.descripcion | slice:0:150}}{{proyecto.descripcion?.length > 150 ? '...' : ''}}</p>
            </div>
            <div class="proyecto-estado">
              <span 
                class="estado-badge" 
                [class]="'estado-' + proyecto.estado">
                {{getEstadoDisplay(proyecto.estado)}}
              </span>
            </div>
          </div>

          <div class="proyecto-details">
            <div class="detail-row">
              <span class="detail-label">Estudiante:</span>
              <span>{{proyecto.estudiante_nombre || 'No asignado'}}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Fecha de creación:</span>
              <span>{{formatearFecha(proyecto.fecha_creacion)}}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Total asignaciones:</span>
              <span>{{contarAsignacionesProyecto(proyecto.id)}}</span>
            </div>
          </div>

          <div class="proyecto-asignaciones">
            <h4><i class="fas fa-users"></i> Profesores Asignados</h4>
            <div *ngIf="getAsignacionesProyecto(proyecto.id).length === 0" class="no-asignaciones">
              <p>No hay profesores asignados a este proyecto</p>
            </div>
            <div class="asignaciones-list">
              <div *ngFor="let asignacion of getAsignacionesProyecto(proyecto.id)" class="asignacion-mini">
                <span class="profesor-nombre">{{asignacion.profesor_nombre}}</span>
                <span 
                  class="rol-badge mini" 
                  [style.background-color]="getRolColor(asignacion.rol_nombre)">
                  {{formatRolName(asignacion.rol_nombre)}}
                </span>
              </div>
            </div>
          </div>

          <div class="proyecto-actions">
            <button 
              class="btn-action btn-primary"
              (click)="verAsignacionesProyecto(proyecto)">
              <i class="fas fa-eye"></i>
              Ver Asignaciones
            </button>
            <button 
              class="btn-action btn-secondary"
              (click)="asignarProfesorAProyecto(proyecto)">
              <i class="fas fa-user-plus"></i>
              Asignar Profesor
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB ESTADÍSTICAS -->
    <div *ngIf="tabActiva === 'estadisticas'" class="estadisticas-section">
      <!-- Loading de estadísticas -->
      <div *ngIf="loadingEstadisticas" class="loading-container">
        <div class="spinner"></div>
        <h3>Cargando estadísticas...</h3>
        <p>Calculando métricas de asignaciones</p>
      </div>

      <div *ngIf="!loadingEstadisticas && estadisticasAsignaciones" class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-project-diagram"></i>
          </div>
          <div class="stat-content">
            <h3>{{estadisticasAsignaciones.totales?.total_proyectos_asignados || 0}}</h3>
            <p>Proyectos con Asignaciones</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-content">
            <h3>{{estadisticasAsignaciones.totales?.total_profesores_activos || 0}}</h3>
            <p>Profesores Activos</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-user-tag"></i>
          </div>
          <div class="stat-content">
            <h3>{{estadisticasAsignaciones.totales?.total_asignaciones_activas || 0}}</h3>
            <p>Asignaciones Activas</p>
          </div>
        </div>
      </div>

      <div class="roles-distribution">
        <h3><i class="fas fa-chart-pie"></i> Distribución por Roles</h3>
        <div class="roles-list">
          <div 
            *ngFor="let rol of estadisticasAsignaciones.por_roles" 
            class="rol-stat">
            <span 
              class="rol-badge" 
              [style.background-color]="getRolColor(rol.rol_nombre)">
              {{rol.rol_nombre.replace('profesor_', '').replace('_', ' ') | titlecase}}
            </span>
            <span class="rol-count">{{rol.asignaciones_por_rol}} asignaciones</span>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB HISTORIAL -->
    <div *ngIf="tabActiva === 'historial'" class="historial-section">
      <div class="historial-list">
        <div *ngIf="historialAsignaciones.length === 0" class="no-results">
          <i class="fas fa-history"></i>
          <h3>No hay historial disponible</h3>
          <p>No se han registrado cambios en las asignaciones</p>
        </div>

        <div *ngFor="let entrada of historialAsignaciones" class="historial-item">
          <div class="historial-icon" [class]="'accion-' + entrada.accion">
            <i class="fas" 
               [class.fa-plus]="entrada.accion === 'asignado'"
               [class.fa-minus]="entrada.accion === 'desasignado'"
               [class.fa-edit]="entrada.accion === 'modificado'">
            </i>
          </div>
          
          <div class="historial-content">
            <div class="historial-header">
              <strong>{{entrada.profesor_nombre}}</strong>
              <span class="accion-text">{{entrada.accion}}</span>
              <span>como</span>
              <span class="rol-name">{{entrada.rol_nombre.replace('profesor_', '').replace('_', ' ') | titlecase}}</span>
            </div>
            <div class="historial-details">
              <span>Proyecto: {{entrada.proyecto_titulo}}</span>
              <span>Por: {{entrada.realizado_por_nombre}}</span>
              <span>{{formatearFecha(entrada.fecha_accion)}}</span>
            </div>
            <div *ngIf="entrada.observaciones" class="historial-observaciones">
              <em>{{entrada.observaciones}}</em>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Botón de volver móvil -->
    <div class="volver-section mobile-only">
      <button class="btn-volver" (click)="volver()">
        <i class="fas fa-arrow-left"></i>
        Volver al Panel de Administración
      </button>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>&copy; {{getCurrentYear()}} Universidad del Bío-Bío. Sistema de Gestión de Títulos.</p>
  </div>
</div>