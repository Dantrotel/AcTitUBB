<div class="solicitudes-reunion-container">
  <!-- Header principal -->
  <div class="header">
    <div class="header-content">
      <h1 *ngIf="userRole === 'estudiante'"><i class="fas fa-calendar-check"></i> Reservar Reunión</h1>
      <h1 *ngIf="userRole === 'profesor'"><i class="fas fa-inbox"></i> Solicitudes Recibidas</h1>
      <p *ngIf="userRole === 'estudiante'">Selecciona un horario disponible de tu profesor y reserva una reunión</p>
      <p *ngIf="userRole === 'profesor'">Gestiona las solicitudes de reunión de tus estudiantes</p>
    </div>
    <div class="header-actions">
      <button class="btn-volver-header" (click)="volver()">
        <i class="fas fa-arrow-left"></i>
        Volver
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <h3>Cargando solicitudes...</h3>
    <p>Obteniendo información de reuniones disponibles</p>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="(errorMessage || successMessage) && !isLoading">
    <div class="alert alert-error" *ngIf="errorMessage">
      <i class="fas fa-exclamation-triangle"></i>
      {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      <i class="fas fa-check-circle"></i>
      {{ successMessage }}
    </div>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!isLoading">
    
    <!-- ================================ -->
    <!-- VISTA PARA ESTUDIANTES -->
    <!-- ================================ -->
    <div *ngIf="userRole === 'estudiante'">
    
    <!-- PASO 1: Seleccionar Profesor -->
    <div class="form-section">
      <div class="section-header">
        <h3><i class="fas fa-user-tie"></i> Paso 1: Seleccionar Profesor</h3>
      </div>
      
      <div class="form-group">
        <label for="profesor">Profesor asignado a tu proyecto:</label>
        <select 
          id="profesor" 
          (change)="onProfesorChange()"
          class="form-control">
          <option value="">-- Selecciona un profesor --</option>
          <option *ngFor="let profesor of profesores" [value]="profesor.rut">
            {{ profesor.nombre }} ({{ profesor.rol_nombre }})
          </option>
        </select>
      </div>

      <div class="profesor-info" *ngIf="profesorSeleccionado">
        <div class="info-card">
          <i class="fas fa-info-circle"></i>
          <div>
            <strong>{{ profesorSeleccionado.nombre }}</strong>
            <p>{{ profesorSeleccionado.email }}</p>
            <p>Rol: {{ profesorSeleccionado.rol_nombre }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- PASO 2: Ver Horarios Disponibles -->
    <div class="form-section" *ngIf="profesorSeleccionado">
      <div class="section-header">
        <h3><i class="fas fa-clock"></i> Paso 2: Horarios Disponibles</h3>
      </div>

      <div *ngIf="isCargandoHorarios" class="loading-small">
        <i class="fas fa-spinner fa-spin"></i> Cargando horarios...
      </div>

      <div *ngIf="!isCargandoHorarios && mostrarHorarios">
        
        <!-- Filtros -->
        <div class="filtros-section">
          <div class="form-group inline">
            <label>Ver horarios de los próximos:</label>
            <select [(ngModel)]="diasAdelante" (change)="cargarHorariosDisponibles(profesorSeleccionado!.rut)" class="form-control-sm">
              <option [value]="7">7 días</option>
              <option [value]="14">14 días</option>
              <option [value]="21">21 días</option>
              <option [value]="30">30 días</option>
            </select>
          </div>
        </div>

        <!-- Grid de Horarios -->
        <div class="horarios-grid" *ngIf="horariosDisponibles.length > 0">
          <div 
            class="horario-card" 
            *ngFor="let horario of horariosDisponibles; trackBy: trackById"
            (click)="seleccionarHorario(horario)"
            [class.disabled]="horario.reservado || isLoading">
            
            <div class="horario-header">
              <div class="dia-badge" [class]="getDiaClass(horario.dia_semana)">
                {{ capitalizarDia(horario.dia_semana) }}
              </div>
              <div class="fecha-badge">
                {{ formatearFechaCorta(horario.fecha_propuesta) }}
              </div>
            </div>

            <div class="horario-content">
              <div class="hora-principal">
                <i class="fas fa-clock"></i>
                {{ formatearHora(horario.hora_inicio) }} - {{ formatearHora(horario.hora_fin) }}
              </div>
              <div class="fecha-completa">
                {{ formatearFecha(horario.fecha_propuesta) }}
              </div>
            </div>

            <div class="horario-footer">
              <button 
                class="btn btn-select" 
                [disabled]="horario.reservado || isLoading">
                <i class="fas fa-check-circle"></i>
                {{ horario.reservado ? 'No disponible' : 'Reservar' }}
              </button>
            </div>
          </div>
        </div>

        <!-- Sin horarios -->
        <div class="empty-state" *ngIf="horariosDisponibles.length === 0">
          <i class="fas fa-calendar-times"></i>
          <h4>No hay horarios disponibles</h4>
          <p>{{ profesorSeleccionado.nombre }} no tiene horarios disponibles en los próximos {{ diasAdelante }} días.</p>
          <p class="hint">Intenta aumentar el rango de días o contacta directamente con el profesor.</p>
        </div>

        <!-- Formulario de reserva (modal inline) -->
        <div class="reserva-form" *ngIf="horariosDisponibles.length > 0">
          <h4><i class="fas fa-edit"></i> Detalles de la reunión</h4>
          <p class="form-hint">Estos detalles se enviarán con tu solicitud</p>
          
          <div class="form-group">
            <label for="tipo_reunion">Tipo de reunión:</label>
            <select 
              id="tipo_reunion" 
              [(ngModel)]="nuevaReserva.tipo_reunion" 
              class="form-control">
              <option *ngFor="let tipo of tiposReunion" [value]="tipo.value">
                {{ tipo.label }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="descripcion">Descripción (opcional):</label>
            <textarea 
              id="descripcion" 
              [(ngModel)]="nuevaReserva.descripcion"
              class="form-control"
              rows="3"
              placeholder="Describe brevemente el propósito de la reunión..."
              maxlength="500">
            </textarea>
            <small>{{ (nuevaReserva.descripcion && nuevaReserva.descripcion.length) || 0 }}/500 caracteres</small>
          </div>
        </div>
      </div>
    </div>

    <!-- PASO 3: Mis Reservas -->
    <div class="solicitudes-list">
      <div class="section-header">
        <h3><i class="fas fa-list"></i> Mis Reservas</h3>
      </div>
      
      <div class="empty-state" *ngIf="solicitudes.length === 0">
        <i class="fas fa-inbox"></i>
        <h4>No tienes reservas</h4>
        <p>Cuando reserves un horario, aparecerá aquí con su estado</p>
      </div>

      <div class="solicitudes-grid" *ngIf="solicitudes.length > 0">
        <div 
          class="solicitud-card" 
          *ngFor="let solicitud of solicitudes; trackBy: trackById"
          [class]="getEstadoClass(solicitud.estado)">
          
          <div class="card-header">
            <div class="profesor-info">
              <h4>{{ solicitud.profesor_nombre || 'Profesor' }}</h4>
              <span class="proyecto-info">{{ solicitud.proyecto_titulo }}</span>
            </div>
            <div class="estado-badge" [class]="getEstadoClass(solicitud.estado)">
              <span class="estado-icon">{{ getEstadoIcon(solicitud.estado) }}</span>
              {{ getEstadoLabel(solicitud.estado) }}
            </div>
          </div>

          <div class="card-content">
            <div class="reunion-detalles">
              <div class="detalle-item">
                <i class="fas fa-calendar"></i>
                <span>{{ solicitud.fecha_propuesta ? formatearFecha(solicitud.fecha_propuesta) : 'Fecha no disponible' }}</span>
              </div>
              <div class="detalle-item">
                <i class="fas fa-clock"></i>
                <span>{{ formatearHora(solicitud.hora_propuesta) }} ({{ solicitud.duracion_minutos }} min)</span>
              </div>
              <div class="detalle-item">
                <i class="fas fa-tag"></i>
                <span>{{ solicitud.tipo_reunion }}</span>
              </div>
            </div>

            <div class="descripcion" *ngIf="solicitud.descripcion">
              <i class="fas fa-align-left"></i>
              <p>{{ solicitud.descripcion }}</p>
            </div>

            <div class="comentarios-profesor" *ngIf="solicitud.comentarios_profesor">
              <div class="comentario-box">
                <strong>Comentario del profesor:</strong>
                <p>{{ solicitud.comentarios_profesor }}</p>
              </div>
            </div>

            <div class="fecha-creacion">
              <small>
                <i class="fas fa-clock"></i>
                Reservada: {{ solicitud.created_at | date:'dd/MM/yyyy HH:mm' }}
              </small>
            </div>
          </div>

          <div class="card-actions" *ngIf="solicitud.estado === 'pendiente'">
            <button 
              class="btn btn-sm btn-danger"
              (click)="cancelarReserva(solicitud.id!)"
              [disabled]="isLoading"
              title="Cancelar esta reserva">
              <i class="fas fa-times"></i>
              Cancelar Reserva
            </button>
          </div>

          <div class="card-info" *ngIf="solicitud.estado === 'aceptada'">
            <div class="alert alert-success-sm">
              <i class="fas fa-check-circle"></i>
              ¡Reunión confirmada! Aparecerá en tu calendario.
            </div>
          </div>

          <div class="card-info" *ngIf="solicitud.estado === 'rechazada'">
            <div class="alert alert-danger-sm">
              <i class="fas fa-times-circle"></i>
              El profesor rechazó esta solicitud.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Información útil -->
    <div class="info-section">
      <div class="info-card">
        <h4><i class="fas fa-lightbulb"></i> ¿Cómo funciona?</h4>
        <ol>
          <li><strong>Selecciona un profesor</strong> de los asignados a tu proyecto</li>
          <li><strong>Revisa los horarios disponibles</strong> que el profesor ha publicado</li>
          <li><strong>Reserva el horario</strong> que más te convenga haciendo clic</li>
          <li><strong>Espera la confirmación</strong> del profesor (recibirás una notificación)</li>
          <li><strong>¡Asiste a tu reunión!</strong> Aparecerá en el calendario</li>
        </ol>
      </div>

      <div class="info-card">
        <h4><i class="fas fa-info-circle"></i> Importante</h4>
        <ul>
          <li>Al reservar, el horario queda bloqueado temporalmente</li>
          <li>El profesor debe aceptar tu solicitud</li>
          <li>Si rechaza, el horario vuelve a estar disponible</li>
          <li>Puedes cancelar reservas pendientes en cualquier momento</li>
          <li>Las reuniones aceptadas aparecen automáticamente en el calendario</li>
        </ul>
      </div>
    </div>
    </div>
    <!-- FIN VISTA ESTUDIANTE -->

    <!-- ================================ -->
    <!-- VISTA PARA PROFESORES -->
    <!-- ================================ -->
    <div *ngIf="userRole === 'profesor'">
      
      <!-- Solicitudes Pendientes -->
      <div class="solicitudes-list">
        <div class="section-header">
          <h3><i class="fas fa-clock"></i> Solicitudes Pendientes</h3>
          <span class="badge-count" *ngIf="haySolicitudesPendientes">
            {{ countPendientes }}
          </span>
        </div>
        
        <div class="empty-state" *ngIf="!haySolicitudesPendientes">
          <i class="fas fa-inbox"></i>
          <h4>No hay solicitudes pendientes</h4>
          <p>Aquí aparecerán las solicitudes de reunión de tus estudiantes</p>
        </div>

        <div class="solicitudes-grid" *ngIf="haySolicitudesPendientes">
          <div 
            class="solicitud-card" 
            *ngFor="let solicitud of solicitudesPendientes; trackBy: trackById">
            
            <div class="card-header">
              <div class="profesor-info">
                <h4>{{ solicitud.estudiante_nombre || 'Estudiante' }}</h4>
                <span class="proyecto-info">{{ solicitud.proyecto_titulo }}</span>
              </div>
              <div class="estado-badge status-pending">
                <span class="estado-icon">⏳</span>
                Pendiente
              </div>
            </div>

            <div class="card-content">
              <div class="reunion-detalles">
                <div class="detalle-item">
                  <i class="fas fa-calendar"></i>
                  <span>{{ solicitud.fecha_propuesta ? formatearFecha(solicitud.fecha_propuesta) : 'Fecha no disponible' }}</span>
                </div>
                <div class="detalle-item">
                  <i class="fas fa-clock"></i>
                  <span>{{ formatearHora(solicitud.hora_propuesta) }} ({{ solicitud.duracion_minutos }} min)</span>
                </div>
                <div class="detalle-item">
                  <i class="fas fa-tag"></i>
                  <span>{{ solicitud.tipo_reunion }}</span>
                </div>
              </div>

              <div class="descripcion" *ngIf="solicitud.descripcion">
                <i class="fas fa-align-left"></i>
                <p>{{ solicitud.descripcion }}</p>
              </div>

              <div class="fecha-creacion">
                <small>
                  <i class="fas fa-clock"></i>
                  Solicitada: {{ solicitud.created_at | date:'dd/MM/yyyy HH:mm' }}
                </small>
              </div>
            </div>

            <div class="card-actions">
              <button 
                class="btn btn-sm btn-success"
                (click)="responderSolicitud(solicitud.id!, 'aceptar')"
                [disabled]="isLoading"
                title="Aceptar solicitud">
                <i class="fas fa-check"></i>
                Aceptar
              </button>
              <button 
                class="btn btn-sm btn-danger"
                (click)="responderSolicitud(solicitud.id!, 'rechazar')"
                [disabled]="isLoading"
                title="Rechazar solicitud">
                <i class="fas fa-times"></i>
                Rechazar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Historial de Solicitudes -->
      <div class="solicitudes-list" *ngIf="haySolicitudesHistorial">
        <div class="section-header">
          <h3><i class="fas fa-history"></i> Historial</h3>
        </div>

        <div class="solicitudes-grid">
          <div 
            class="solicitud-card" 
            *ngFor="let solicitud of solicitudesHistorial; trackBy: trackById"
            [class]="getEstadoClass(solicitud.estado)">
            
            <div class="card-header">
              <div class="profesor-info">
                <h4>{{ solicitud.estudiante_nombre || 'Estudiante' }}</h4>
                <span class="proyecto-info">{{ solicitud.proyecto_titulo }}</span>
              </div>
              <div class="estado-badge" [class]="getEstadoClass(solicitud.estado)">
                <span class="estado-icon">{{ getEstadoIcon(solicitud.estado) }}</span>
                {{ getEstadoLabel(solicitud.estado) }}
              </div>
            </div>

            <div class="card-content">
              <div class="reunion-detalles">
                <div class="detalle-item">
                  <i class="fas fa-calendar"></i>
                  <span>{{ solicitud.fecha_propuesta ? formatearFecha(solicitud.fecha_propuesta) : 'Fecha no disponible' }}</span>
                </div>
                <div class="detalle-item">
                  <i class="fas fa-clock"></i>
                  <span>{{ formatearHora(solicitud.hora_propuesta) }} ({{ solicitud.duracion_minutos }} min)</span>
                </div>
                <div class="detalle-item">
                  <i class="fas fa-tag"></i>
                  <span>{{ solicitud.tipo_reunion }}</span>
                </div>
              </div>

              <div class="descripcion" *ngIf="solicitud.descripcion">
                <i class="fas fa-align-left"></i>
                <p>{{ solicitud.descripcion }}</p>
              </div>

              <div class="comentarios-profesor" *ngIf="solicitud.comentarios_profesor">
                <div class="comentario-box">
                  <strong>Tu comentario:</strong>
                  <p>{{ solicitud.comentarios_profesor }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Información para profesores -->
      <div class="info-section">
        <div class="info-card">
          <h4><i class="fas fa-info-circle"></i> Información</h4>
          <ul>
            <li>Las solicitudes pendientes requieren tu aprobación</li>
            <li>Al aceptar, la reunión se agrega automáticamente al calendario</li>
            <li>Al rechazar, debes proporcionar un motivo para el estudiante</li>
            <li>Las reuniones aceptadas aparecen en "Calendario" y "Gestión de Reuniones"</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- FIN VISTA PROFESOR -->

  </div>
</div>