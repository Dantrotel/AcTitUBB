<div class="solicitudes-reunion-container">
  <!-- Header principal -->
  <div class="header">
    <div class="header-content">
      <h1 *ngIf="userRole === 'estudiante'"><i class="fas fa-calendar-check"></i> Reservar Reunión</h1>
      <h1 *ngIf="userRole === 'profesor'"><i class="fas fa-inbox"></i> Solicitudes Recibidas</h1>
      <p *ngIf="userRole === 'estudiante'">Selecciona un horario disponible de tu profesor y reserva una reunión</p>
      <p *ngIf="userRole === 'profesor'">Gestiona las solicitudes de reunión de tus estudiantes</p>
    </div>
    <div class="header-actions">
      <button class="btn-volver-header" (click)="volver()">
        <i class="fas fa-arrow-left"></i>
        Volver
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <h3>Cargando solicitudes...</h3>
    <p>Obteniendo información de reuniones disponibles</p>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="(errorMessage || successMessage) && !isLoading">
    <div class="alert alert-error" *ngIf="errorMessage">
      <i class="fas fa-exclamation-triangle"></i>
      {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      <i class="fas fa-check-circle"></i>
      {{ successMessage }}
    </div>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!isLoading">
    
    <!-- ================================ -->
    <!-- VISTA PARA ESTUDIANTES -->
    <!-- ================================ -->
    <div *ngIf="userRole === 'estudiante'">
    
    <!-- PASO 1: Seleccionar Profesor -->
    <div class="form-section paso-1">
      <div class="section-header-modern">
        <div class="step-badge">1</div>
        <div class="section-info">
          <h3><i class="fas fa-user-tie"></i> Seleccionar Profesor</h3>
          <p class="section-subtitle">Profesor asignado a tu proyecto</p>
        </div>
      </div>
      
      <div class="form-group-modern">
        <div class="input-with-icon">
          <i class="fas fa-chalkboard-teacher input-icon"></i>
          <select 
            id="profesor" 
            (change)="onProfesorChange()"
            class="form-control-modern">
            <option value="">Usuario Profesor (Profesor Guía)</option>
            <option *ngFor="let profesor of profesores" [value]="profesor.rut">
              {{ profesor.nombre }} - {{ profesor.rol_nombre }}
            </option>
          </select>
        </div>
      </div>

      <div class="profesor-card-modern" *ngIf="profesorSeleccionado">
        <div class="profesor-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="profesor-details">
          <h4>{{ profesorSeleccionado.nombre }}</h4>
          <p class="profesor-email"><i class="fas fa-envelope"></i> {{ profesorSeleccionado.email }}</p>
          <span class="profesor-rol-badge">{{ profesorSeleccionado.rol_nombre }}</span>
        </div>
      </div>
    </div>

    <!-- PASO 2: Detalles de la Reunión -->
    <div class="form-section paso-2" *ngIf="profesorSeleccionado">
      <div class="section-header-modern">
        <div class="step-badge">2</div>
        <div class="section-info">
          <h3><i class="fas fa-clipboard-list"></i> Detalles de la Reunión</h3>
          <p class="section-subtitle">Completa la información para tu solicitud</p>
        </div>
      </div>

      <div class="reserva-form-modern">
        <div class="form-header-modern">
          <div class="header-icon">
            <i class="fas fa-info-circle"></i>
          </div>
          <div class="header-content">
            <h4>Información de la Reunión</h4>
            <p>Define el tipo y propósito de tu reunión</p>
          </div>
        </div>
        
        <div class="form-body-modern">
          <div class="form-group-elegant">
            <label for="tipo_reunion">
              <i class="fas fa-tag"></i>
              Tipo de Reunión
            </label>
            <select 
              id="tipo_reunion" 
              [(ngModel)]="nuevaReserva.tipo_reunion" 
              class="form-control-elegant">
              <option *ngFor="let tipo of tiposReunion" [value]="tipo.value">
                {{ tipo.label }}
              </option>
            </select>
          </div>

          <div class="form-group-elegant">
            <label for="descripcion">
              <i class="fas fa-align-left"></i>
              Descripción <span class="optional">(opcional)</span>
            </label>
            <textarea 
              id="descripcion" 
              [(ngModel)]="nuevaReserva.descripcion"
              class="form-control-elegant textarea-elegant"
              rows="4"
              maxlength="500"
              placeholder="Describe el tema o propósito de la reunión...">
            </textarea>
            <div class="char-counter">
              <i class="fas fa-keyboard"></i>
              {{ (nuevaReserva.descripcion && nuevaReserva.descripcion.length) || 0 }}/500 caracteres
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PASO 3: Ver Horarios Disponibles -->
    <div class="form-section paso-3" *ngIf="profesorSeleccionado">
      <div class="section-header-modern">
        <div class="step-badge">3</div>
        <div class="section-info">
          <h3><i class="fas fa-clock"></i> Horarios Disponibles</h3>
          <p class="section-subtitle">Selecciona la fecha y hora que mejor te convenga</p>
        </div>
      </div>

      <div *ngIf="isCargandoHorarios" class="loading-small-modern">
        <div class="spinner-small"></div>
        <span>Cargando horarios disponibles...</span>
      </div>

      <div *ngIf="!isCargandoHorarios && mostrarHorarios">
        
        <!-- Filtros Modernos -->
        <div class="filtros-section-modern">
          <div class="filtro-container">
            <i class="fas fa-calendar-week filtro-icon"></i>
            <label>Ver horarios de los próximos:</label>
            <select [(ngModel)]="diasAdelante" (change)="cargarHorariosDisponibles(profesorSeleccionado!.rut)" class="form-control-filtro">
              <option [value]="7">7 días</option>
              <option [value]="14">14 días</option>
              <option [value]="21">21 días</option>
              <option [value]="30">30 días</option>
            </select>
          </div>
        </div>

        <!-- Grid de Horarios Modernos -->
        <div class="horarios-grid-modern" *ngIf="horariosDisponibles.length > 0">
          <div 
            class="horario-card-modern" 
            *ngFor="let horario of horariosDisponibles; trackBy: trackById"
            (click)="seleccionarHorario(horario)"
            [class.disabled]="horario.reservado || isLoading">
            
            <!-- Badge del día -->
            <div class="dia-badge-modern" [class]="getDiaClass(horario.dia_semana)">
              <span class="dia-nombre">{{ capitalizarDia(horario.dia_semana) }}</span>
            </div>

            <!-- Contenido principal -->
            <div class="horario-body-modern">
              <div class="fecha-display">
                <i class="fas fa-calendar-day"></i>
                <span class="fecha-corta">{{ formatearFechaCorta(horario.fecha_propuesta) }}</span>
              </div>
              
              <div class="hora-display">
                <i class="fas fa-clock"></i>
                <span class="hora-texto">{{ formatearHora(horario.hora_inicio) }} - {{ formatearHora(horario.hora_fin) }}</span>
              </div>
              
              <div class="fecha-completa-display">
                <i class="fas fa-calendar-check"></i>
                <span>{{ formatearFecha(horario.fecha_propuesta) }}</span>
              </div>
            </div>

            <!-- Botón de acción -->
            <div class="horario-action-modern">
              <button 
                class="btn-reservar-modern" 
                [disabled]="horario.reservado || isLoading"
                [class.disabled]="horario.reservado">
                <i class="fas fa-check-circle"></i>
                <span>{{ horario.reservado ? 'No disponible' : 'Reservar' }}</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Sin horarios moderno -->
        <div class="empty-state-horarios" *ngIf="horariosDisponibles.length === 0">
          <div class="empty-icon-horarios">
            <i class="fas fa-calendar-times"></i>
          </div>
          <h4>No hay horarios disponibles</h4>
          <p class="empty-text">{{ profesorSeleccionado.nombre }} no tiene horarios disponibles en los próximos <strong>{{ diasAdelante }} días</strong>.</p>
          <div class="empty-hint">
            <i class="fas fa-lightbulb"></i>
            <span>Intenta aumentar el rango de días o contacta directamente con el profesor.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PASO 4: Mis Reservas -->
    <div class="solicitudes-list">
      <div class="section-header-modern">
        <div class="step-badge">4</div>
        <div class="section-info">
          <h3><i class="fas fa-list"></i> Mis Reservas</h3>
          <p class="section-subtitle">Gestiona tus solicitudes de reunión</p>
        </div>
      </div>
      
      <div class="empty-state-modern" *ngIf="solicitudes.length === 0">
        <div class="empty-icon">
          <i class="fas fa-calendar-times"></i>
        </div>
        <h4>No tienes reservas</h4>
        <p>Cuando reserves un horario, aparecerá aquí con su estado</p>
      </div>

      <div class="solicitudes-grid" *ngIf="solicitudes.length > 0">
        <div 
          class="solicitud-card" 
          *ngFor="let solicitud of solicitudes; trackBy: trackById"
          [class]="getEstadoClass(solicitud.estado)">
          
          <div class="card-header">
            <div class="profesor-info">
              <h4>{{ solicitud.profesor_nombre || 'Profesor' }}</h4>
              <span class="proyecto-info">{{ solicitud.proyecto_titulo }}</span>
            </div>
            <div class="estado-badge" [class]="getEstadoClass(solicitud.estado)">
              <span class="estado-icon">{{ getEstadoIcon(solicitud.estado) }}</span>
              {{ getEstadoLabel(solicitud.estado) }}
            </div>
          </div>

          <div class="card-content">
            <div class="reunion-detalles">
              <div class="detalle-item">
                <i class="fas fa-calendar"></i>
                <span>{{ solicitud.fecha_propuesta ? formatearFecha(solicitud.fecha_propuesta) : 'Fecha no disponible' }}</span>
              </div>
              <div class="detalle-item">
                <i class="fas fa-clock"></i>
                <span>{{ formatearHora(solicitud.hora_propuesta) }} ({{ solicitud.duracion_minutos }} min)</span>
              </div>
              <div class="detalle-item">
                <i class="fas fa-tag"></i>
                <span>{{ solicitud.tipo_reunion }}</span>
              </div>
            </div>

            <div class="descripcion" *ngIf="solicitud.descripcion">
              <i class="fas fa-align-left"></i>
              <p>{{ solicitud.descripcion }}</p>
            </div>

            <div class="comentarios-profesor" *ngIf="solicitud.comentarios_profesor">
              <div class="comentario-box">
                <strong>Comentario del profesor:</strong>
                <p>{{ solicitud.comentarios_profesor }}</p>
              </div>
            </div>

            <div class="fecha-creacion">
              <small>
                <i class="fas fa-clock"></i>
                Reservada: {{ solicitud.created_at | date:'dd/MM/yyyy HH:mm' }}
              </small>
            </div>
          </div>

          <div class="card-actions" *ngIf="solicitud.estado === 'pendiente'">
            <button 
              class="btn btn-sm btn-danger"
              (click)="cancelarReserva(solicitud.id!)"
              [disabled]="isLoading"
              title="Cancelar esta reserva">
              <i class="fas fa-times"></i>
              Cancelar Reserva
            </button>
          </div>

          <div class="card-info" *ngIf="solicitud.estado === 'aceptada'">
            <div class="alert alert-success-sm">
              <i class="fas fa-check-circle"></i>
              ¡Reunión confirmada! Aparecerá en tu calendario.
            </div>
          </div>

          <div class="card-info" *ngIf="solicitud.estado === 'rechazada'">
            <div class="alert alert-danger-sm">
              <i class="fas fa-times-circle"></i>
              El profesor rechazó esta solicitud.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Información útil -->
    <div class="info-section">
      <div class="info-card">
        <h4><i class="fas fa-lightbulb"></i> ¿Cómo funciona?</h4>
        <ol>
          <li><strong>Selecciona un profesor</strong> de los asignados a tu proyecto</li>
          <li><strong>Revisa los horarios disponibles</strong> que el profesor ha publicado</li>
          <li><strong>Reserva el horario</strong> que más te convenga haciendo clic</li>
          <li><strong>Espera la confirmación</strong> del profesor (recibirás una notificación)</li>
          <li><strong>¡Asiste a tu reunión!</strong> Aparecerá en el calendario</li>
        </ol>
      </div>

      <div class="info-card">
        <h4><i class="fas fa-info-circle"></i> Importante</h4>
        <ul>
          <li>Al reservar, el horario queda bloqueado temporalmente</li>
          <li>El profesor debe aceptar tu solicitud</li>
          <li>Si rechaza, el horario vuelve a estar disponible</li>
          <li>Puedes cancelar reservas pendientes en cualquier momento</li>
          <li>Las reuniones aceptadas aparecen automáticamente en el calendario</li>
        </ul>
      </div>
    </div>
    </div>
    <!-- FIN VISTA ESTUDIANTE -->

    <!-- ================================ -->
    <!-- VISTA PARA PROFESORES -->
    <!-- ================================ -->
    <div *ngIf="userRole === 'profesor'">
      
      <!-- Solicitudes Pendientes -->
      <div class="solicitudes-list">
        <div class="section-header">
          <h3><i class="fas fa-clock"></i> Solicitudes Pendientes</h3>
          <span class="badge-count" *ngIf="haySolicitudesPendientes">
            {{ countPendientes }}
          </span>
        </div>
        
        <div class="empty-state" *ngIf="!haySolicitudesPendientes">
          <i class="fas fa-inbox"></i>
          <h4>No hay solicitudes pendientes</h4>
          <p>Aquí aparecerán las solicitudes de reunión de tus estudiantes</p>
        </div>

        <div class="solicitudes-grid" *ngIf="haySolicitudesPendientes">
          <div 
            class="solicitud-card" 
            *ngFor="let solicitud of solicitudesPendientes; trackBy: trackById">
            
            <div class="card-header">
              <div class="profesor-info">
                <h4>{{ solicitud.estudiante_nombre || 'Estudiante' }}</h4>
                <span class="proyecto-info">{{ solicitud.proyecto_titulo }}</span>
              </div>
              <div class="estado-badge status-pending">
                <span class="estado-icon">⏳</span>
                Pendiente
              </div>
            </div>

            <div class="card-content">
              <div class="reunion-detalles">
                <div class="detalle-item">
                  <i class="fas fa-calendar"></i>
                  <span>{{ solicitud.fecha_propuesta ? formatearFecha(solicitud.fecha_propuesta) : 'Fecha no disponible' }}</span>
                </div>
                <div class="detalle-item">
                  <i class="fas fa-clock"></i>
                  <span>{{ formatearHora(solicitud.hora_propuesta) }} ({{ solicitud.duracion_minutos }} min)</span>
                </div>
                <div class="detalle-item">
                  <i class="fas fa-tag"></i>
                  <span>{{ solicitud.tipo_reunion }}</span>
                </div>
              </div>

              <div class="descripcion" *ngIf="solicitud.descripcion">
                <i class="fas fa-align-left"></i>
                <p>{{ solicitud.descripcion }}</p>
              </div>

              <div class="fecha-creacion">
                <small>
                  <i class="fas fa-clock"></i>
                  Solicitada: {{ solicitud.created_at | date:'dd/MM/yyyy HH:mm' }}
                </small>
              </div>
            </div>

            <div class="card-actions">
              <button 
                class="btn btn-sm btn-success"
                (click)="responderSolicitud(solicitud.id!, 'aceptar')"
                [disabled]="isLoading"
                title="Aceptar solicitud">
                <i class="fas fa-check"></i>
                Aceptar
              </button>
              <button 
                class="btn btn-sm btn-danger"
                (click)="responderSolicitud(solicitud.id!, 'rechazar')"
                [disabled]="isLoading"
                title="Rechazar solicitud">
                <i class="fas fa-times"></i>
                Rechazar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Historial de Solicitudes -->
      <div class="solicitudes-list" *ngIf="haySolicitudesHistorial">
        <div class="section-header">
          <h3><i class="fas fa-history"></i> Historial</h3>
        </div>

        <div class="solicitudes-grid">
          <div 
            class="solicitud-card" 
            *ngFor="let solicitud of solicitudesHistorial; trackBy: trackById"
            [class]="getEstadoClass(solicitud.estado)">
            
            <div class="card-header">
              <div class="profesor-info">
                <h4>{{ solicitud.estudiante_nombre || 'Estudiante' }}</h4>
                <span class="proyecto-info">{{ solicitud.proyecto_titulo }}</span>
              </div>
              <div class="estado-badge" [class]="getEstadoClass(solicitud.estado)">
                <span class="estado-icon">{{ getEstadoIcon(solicitud.estado) }}</span>
                {{ getEstadoLabel(solicitud.estado) }}
              </div>
            </div>

            <div class="card-content">
              <div class="reunion-detalles">
                <div class="detalle-item">
                  <i class="fas fa-calendar"></i>
                  <span>{{ solicitud.fecha_propuesta ? formatearFecha(solicitud.fecha_propuesta) : 'Fecha no disponible' }}</span>
                </div>
                <div class="detalle-item">
                  <i class="fas fa-clock"></i>
                  <span>{{ formatearHora(solicitud.hora_propuesta) }} ({{ solicitud.duracion_minutos }} min)</span>
                </div>
                <div class="detalle-item">
                  <i class="fas fa-tag"></i>
                  <span>{{ solicitud.tipo_reunion }}</span>
                </div>
              </div>

              <div class="descripcion" *ngIf="solicitud.descripcion">
                <i class="fas fa-align-left"></i>
                <p>{{ solicitud.descripcion }}</p>
              </div>

              <div class="comentarios-profesor" *ngIf="solicitud.comentarios_profesor">
                <div class="comentario-box">
                  <strong>Tu comentario:</strong>
                  <p>{{ solicitud.comentarios_profesor }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Información para profesores -->
      <div class="info-section">
        <div class="info-card">
          <h4><i class="fas fa-info-circle"></i> Información</h4>
          <ul>
            <li>Las solicitudes pendientes requieren tu aprobación</li>
            <li>Al aceptar, la reunión se agrega automáticamente al calendario</li>
            <li>Al rechazar, debes proporcionar un motivo para el estudiante</li>
            <li>Las reuniones aceptadas aparecen en "Calendario" y "Gestión de Reuniones"</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- FIN VISTA PROFESOR -->

  </div>
</div>